'*****************************************************************************************
'This file is a part of WinDevLib - Windows Development Library for twinBASIC
'https://github.com/fafalone/WinDevLib
'Code ported by Jon Johnson. 
'"Windows" is a trademark of the Microsoft Corporation.
'Certain Description attributes (c) Microsoft, taken from SDK headers and official docs.
'Licensed under Creative Commons CC0 1.0 Universal
'*****************************************************************************************

'WinDevLib - wdSecurity :: Security Page Interfaces / COM Security


	#If WINDEVLIB_LITE = 0 Then 'these make no sense without access control APIs
	[InterfaceId("EEDD23E0-8410-11CE-A1C3-08002B2B8D8F")]
    [OleAutomation(False)]
    Interface IAccessControl Extends IUnknown
		Sub GrantAccessRights(pAccessList As ACTRL_ACCESSW)
        Sub SetAccessRights(pAccessList As ACTRL_ACCESSW)
		Sub SetOwner(pOwner As TRUSTEEW, pGroup As TRUSTEEW)
		Sub RevokeAccessRights(ByVal lpProperty As LongPtr, ByVal cTrustees As Long, prgTrustees As TRUSTEEW)
		Sub GetAllAccessRights(ByVal lpProperty As LongPtr, ppAccessList As LongPtr, ppOwner As LongPtr, ppGroup As LongPtr)
		Sub IsAccessAllowed(pTrustee As TRUSTEEW, ByVal lpProperty As LongPtr, ByVal AccessRights As Long, pfAccessAllowed As BOOL)
	End Interface
	
	[InterfaceId("1da6292f-bc66-11ce-aae3-00aa004c2737")]
    [OleAutomation(False)]
    Interface IAuditControl Extends IUnknown
        Sub GrantAuditRights(pAuditList As ACTRL_AUDITW)
        Sub SetAuditRights(pAuditList As ACTRL_AUDITW)
		Sub RevokeAuditRights(ByVal lpProperty As LongPtr, ByVal cTrustees As Long, prgTrustees As TRUSTEEW)
		Sub GetAllAuditRights(ByVal lpProperty As LongPtr, ppAuditList As LongPtr)
		Sub IsAccessAudited(pTrustee As TRUSTEEW, ByVal AuditRights As Long, pfAccessAudited As BOOL)
	End Interface


    [InterfaceId("965FC360-16FF-11D0-91CB-00AA00BBB723")]
    [OleAutomation(False)]
    Interface ISecurityInformation Extends stdole.IUnknown
        Sub GetObjectInformation(ByRef pObjectInfo As SI_OBJECT_INFO)
        Sub GetSecurity(ByVal RequestedInformation As SECURITY_INFORMATION, ByRef pSecurityDescriptor As LongPtr, ByVal fDefault As BOOL)
        Sub SetSecurity(ByVal securityInformation As SECURITY_INFORMATION, ByVal pSecurityDescriptpr As LongPtr)
        Sub GetAccessRights(ByRef pguidObjectType As UUID, ByVal dwFlags As Long, ByRef ppAccess As LongPtr, ByRef pcAccesses As Long, ByRef piDefaultAccess As Long)
        Sub MapGeneric(ByRef pguidObjectType As UUID, ByVal pAceFlags As LongPtr, ByRef pMask As Long)
        Sub GetInheritTypes(ByRef ppInheritTypes As LongPtr, ByRef pcInheritTypes As Long)
        Sub PropertySheetPageCallback(ByVal hwnd As LongPtr, ByVal uMsg As PSPCALLBACKMESSAGES, ByVal uPage As SI_PAGE_TYPE)
    End Interface

    [InterfaceId("C3CCFDB4-6F88-11D2-A3CE-00C04FB1782A")]
    [OleAutomation(False)]
    Interface ISecurityInformation2 Extends stdole.IUnknown
        Sub IsDaclCanonical(ByVal pDacl As LongPtr)
        Sub LookupSids(ByVal cSids As Long, ByRef rgpSids As LongPtr, ByRef ppdo As IDataObject)
    End Interface
    
    [InterfaceId("3853DC76-9F35-407C-88A1-D19344365FBC")]
    [OleAutomation(False)]
    Interface IEffectivePermission Extends stdole.IUnknown
        Sub GetEffectivePermission(ByRef pguidObjectType As UUID, ByVal pUserSid As LongPtr, ByVal pszServerName As LongPtr, ByRef psd As Any, ByRef ppObjectTypeList As LongPtr, ByRef pcObjectTypeListLength As Long, ByRef ppGrantedAccessList As LongPtr, ByRef pcGrantedAccessListLength As Long)
    End Interface

    [InterfaceId("FC3066EB-79EF-444B-9111-D18A75EBF2FA")]
    [OleAutomation(False)]
    Interface ISecurityObjectTypeInfo Extends stdole.IUnknown
        Sub GetInheritSource(ByVal si As SECURITY_INFORMATION, ByVal pACL As LongPtr, ByRef ppInheritArray As LongPtr)
    End Interface

    [InterfaceId("E2CDC9CC-31BD-4F8F-8C8B-B641AF516A1A")]
    [OleAutomation(False)]
    Interface ISecurityInformation3 Extends stdole.IUnknown
        Sub GetFullResourceName(ByRef ppszResourceName As LongPtr)
        Sub OpenElevatedEditor(ByVal hwnd As LongPtr, ByVal uPage As SI_PAGE_TYPE)
    End Interface
    
    [InterfaceId("EA961070-CD14-4621-ACE4-F63C03E583E4")]
    [OleAutomation(False)]
    Interface ISecurityInformation4 Extends stdole.IUnknown
        Sub GetSecondarySecurity(ByRef pSecurityObjects As LongPtr, ByRef pSecurityObectCount As Long)
    End Interface

    [InterfaceId("941FABCA-DD47-4FCA-90BB-B0E10255F20D")]
    [OleAutomation(False)]
    Interface IEffectivePermission2 Extends stdole.IUnknown
        Sub ComputeEffectivePermissionWithSecondarySecurity(ByVal pSid As LongPtr, ByVal pDeviceSid As LongPtr, ByVal pszServerName As LongPtr, _
                  pSecurityObjects As SECURITY_OBJECT, ByVal dwSecurityObjectCount As Long, pUserGroups As TOKEN_GROUPS, _
                  pAuthzUserGroupsOperations As AUTHZ_SID_OPERATION, pDeviceGroups As TOKEN_GROUPS, _
                  pAuthzDeviceGroupsOperations As AUTHZ_SID_OPERATION, pAuthzUserClaims As AUTHZ_SECURITY_ATTRIBUTES_INFORMATION, _
                  pAuthzUserClaimsOperations As AUTHZ_SECURITY_ATTRIBUTE_OPERATION, pAuthzDeviceClaims As AUTHZ_SECURITY_ATTRIBUTES_INFORMATION, _
                  pAuthzDeviceClaimsOperations As AUTHZ_SECURITY_ATTRIBUTE_OPERATION, pEffpermResultLists As EFFPERM_RESULT_LIST)
    End Interface

    
    
#If WDL_QUALIFY Then
[MustBeQualified]
#End If
Module wdSecurity


Public Enum SIOI_Flags
	SI_EDIT_PERMS = &H00000000 ' always implied
	SI_EDIT_OWNER = &H00000001
	SI_EDIT_AUDITS = &H00000002
	SI_CONTAINER = &H00000004
	SI_READONLY = &H00000008
	SI_ADVANCED = &H00000010
	SI_RESET = &H00000020 'equals to SI_RESET_DAC,|SI_RESET_SAC,|SI_RESET_OWNER
	SI_OWNER_READONLY = &H00000040
	SI_EDIT_PROPERTIES = &H00000080
	SI_OWNER_RECURSE = &H00000100
	SI_NO_ACL_PROTECT = &H00000200
	SI_NO_TREE_APPLY = &H00000400
	SI_PAGE_TITLE = &H00000800
	SI_SERVER_IS_DC = &H00001000
	SI_RESET_DACL_TREE = &H00004000
	SI_RESET_SACL_TREE = &H00008000&
	SI_OBJECT_GUID = &H00010000
	SI_EDIT_EFFECTIVE = &H00020000
	SI_RESET_DACL = &H00040000
	SI_RESET_SACL = &H00080000
	SI_RESET_OWNER = &H00100000
	SI_NO_ADDITIONAL_PERMISSION = &H00200000
	' Vista+
	SI_VIEW_ONLY = &H00400000
	SI_PERMS_ELEVATION_REQUIRED = &H01000000
	SI_AUDITS_ELEVATION_REQUIRED = &H02000000
	SI_OWNER_ELEVATION_REQUIRED = &H04000000
	' Win8+
	SI_SCOPE_ELEVATION_REQUIRED = &H08000000
	' Vista+
	SI_MAY_WRITE = &H10000000 'not sure if user can write permission
	' Win8+
	SI_ENABLE_EDIT_ATTRIBUTE_CONDITION = &H20000000
	SI_ENABLE_CENTRAL_POLICY = &H40000000
	SI_DISABLE_DENY_ACE = &H80000000
	SI_EDIT_ALL = &H3 '(SI_EDIT_PERMS | SI_EDIT_OWNER | SI_EDIT_AUDITS)
End Enum

Public Type SI_OBJECT_INFO
	dwFlags As SIOI_Flags
	hInstance As LongPtr ' resources (e.g. strings) reside here
	pszServerName As LongPtr ' must be present
	pszObjectName As LongPtr ' must be present
	pszPageTitle As LongPtr ' only valid if SI_PAGE_TITLE is set
	guidObjectType As UUID ' only valid if SI_OBJECT_GUID is set
End Type

Public Enum SIAC_Flags
	SI_ACCESS_SPECIFIC = &H00010000
	SI_ACCESS_GENERAL = &H00020000
	SI_ACCESS_CONTAINER = &H00040000 ' general access, container-only
	SI_ACCESS_PROPERTY = &H00080000
End Enum

Public Type SI_ACCESS
	pguid As LongPtr
	mask As Long
	pszName As LongPtr ' may be resource ID
	dwFlags As SIAC_Flags
End Type

Public Type SI_INHERIT_TYPE
	pguid As LongPtr
	dwFlags As Long
	pszName As LongPtr ' may be resource ID
End Type

Public Enum SI_PAGE_TYPE
	SI_PAGE_PERM = 0
	SI_PAGE_ADVPERM
	SI_PAGE_AUDIT
	SI_PAGE_OWNER
	SI_PAGE_EFFECTIVE
	' #if (NTDDI_VERSION >= NTDDI_VISTA)
	SI_PAGE_TAKEOWNERSHIP
	' #endif // (NTDDI_VERSION >= NTDDI_VISTA)
	' #if (NTDDI_VERSION >= NTDDI_WIN8)
	SI_PAGE_SHARE
	' #endif
End Enum

Public Enum SI_PAGE_ACTIVATED
	SI_SHOW_DEFAULT = 0
	SI_SHOW_PERM_ACTIVATED
	SI_SHOW_AUDIT_ACTIVATED
	SI_SHOW_OWNER_ACTIVATED
	SI_SHOW_EFFECTIVE_ACTIVATED
	SI_SHOW_SHARE_ACTIVATED
	SI_SHOW_CENTRAL_POLICY_ACTIVATED
End Enum

Public Type SID_INFO
	pSid As LongPtr
	pwzCommonName As LongPtr
	pwzClass As LongPtr ' Used for selecting icon, e.g. "User" or "Group"
	pwzUPN As LongPtr ' Optional, may be NULL
End Type

Public Type SID_INFO_LIST
	cItems As Long
	aSidInfo(0 To 0) As SID_INFO
End Type

Public Enum SecurityObjectIds
	SECURITY_OBJECT_ID_OBJECT_SD = 1
	SECURITY_OBJECT_ID_SHARE = 2
	SECURITY_OBJECT_ID_CENTRAL_POLICY = 3
	SECURITY_OBJECT_ID_CENTRAL_ACCESS_RULE = 4
End Enum

Public Type SECURITY_OBJECT
	pwszName As LongPtr
	pData As LongPtr
	cbData As Long
	pData2 As LongPtr
	cbData2 As Long
	Id As SecurityObjectIds
	fWellKnown As Byte
End Type

Public Type EFFPERM_RESULT_LIST
	fEvaluated As Byte
	cObjectTypeListLength As Long
	pObjectTypeList As LongPtr
	pGrantedAccessList As LongPtr
End Type

Public Const PSPCB_SI_INITDIALOG As Long = 1025
Public Const DOBJ_RES_CONT As Long = 1
Public Const DOBJ_RES_ROOT As Long = 2
Public Const DOBJ_VOL_NTACLS As Long = 4
Public Const DOBJ_COND_NTACLS As Long = 8
Public Const DOBJ_RIBBON_LAUNCH As Long = 16

Public Declare PtrSafe Function CreateSecurityPage Lib "Aclui.dll" (ByVal psi As ISecurityInformation) As LongPtr
Public Declare PtrSafe Function EditSecurityAdvanced Lib "Aclui.dll" (ByVal hWndOwner As LongPtr, ByVal psi As ISecurityInformation, ByVal uSIPage As SI_PAGE_TYPE) As Long
Public Declare PtrSafe Function EditSecurity Lib "Aclui.dll" (ByVal hWndOwner As LongPtr, ByVal psi As ISecurityInformation) As Long

Public Enum DSSecObjFlags
    DSSI_READ_ONLY = &H00000001
    DSSI_NO_ACCESS_CHECK = &H00000002
    DSSI_NO_EDIT_SACL = &H00000004
    DSSI_NO_EDIT_OWNER = &H00000008
    DSSI_IS_ROOT = &H00000010
    DSSI_NO_FILTER = &H00000020
    DSSI_NO_READONLY_MESSAGE = &H00000040
End Enum

Public DeclareWide PtrSafe Function DSCreateISecurityInfoObject Lib "DSSec" (ByVal pwszObjectPath As String, ByVal pwszObjectClass As String, ByVal dwFlags As DSSecObjFlags, ppSI As ISecurityInformation, ByVal pfnReadSD As LongPtr, ByVal pfnWriteSD As LongPtr, ByVal lpContext As LongPtr) As Long
Public DeclareWide PtrSafe Function DSCreateISecurityInfoObjectEx Lib "DSSec" (ByVal pwszObjectPath As String, ByVal pwszObjectClass As String, ByVal pwszServer As String, ByVal pwszUsername As String, ByVal pwszPassword As String, ByVal dwFlags As DSSecObjFlags, ppSI As ISecurityInformation, ByVal pfnReadSD As LongPtr, ByVal pfnWriteSD As LongPtr, ByVal lpContext As LongPtr) As Long
Public DeclareWide PtrSafe Function DSCreateSecurityPage Lib "DSSec" (ByVal pwszObjectPath As String, ByVal pwszObjectClass As String, ByVal dwFlags As DSSecObjFlags, phPage As LongPtr, ByVal pfnReadSD As LongPtr, ByVal pfnWriteSD As LongPtr, ByVal lpContext As LongPtr) As Long
Public DeclareWide PtrSafe Function DSEditSecurity Lib "DSSec" (ByVal hwndOwner As LongPtr, ByVal pwszObjectPath As String, ByVal pwszObjectClass As String, ByVal dwFlags As DSSecObjFlags, ByVal pwszCaption As String, ByVal pfnReadSD As LongPtr, ByVal pfnWriteSD As LongPtr, ByVal lpContext As LongPtr) As Long


'security.h (100%)
Public Const NTLMSP_NAME_A  = "NTLM"
Public Const NTLMSP_NAME  = "NTLM"  ' ntifs

Public Const NEGOSSP_NAME_W  = "Negotiate"
Public Const NEGOSSP_NAME_A  = "Negotiate"
Public Const NEGOSSP_NAME  = NEGOSSP_NAME_W

Public Const CLOUDAP_NAME_W  = "CloudAP"
Public Const ClOUDAP_NAME_A  = "CloudAP"
Public Const CLOUDAP_NAME  = CLOUDAP_NAME_W

/*
sspi.h
Coverage: (in progress)
*/

Public Type SecHandle
    dwLower As LongPtr
    dwUpper As LongPtr
End Type

Public Sub SecInvalidateHandle(x As SecHandle)
    x.dwLower = -1: x.dwUpper = -1
End Sub
Public Function SecIsValidHandle(x As SecHandle) As Boolean
    If (x.dwLower <> -1) AndAlso (x.dwUpper <> -1) Then Return True
End Function

Public Const SEC_DELETED_HANDLE As LongPtr = -2

'Alias CredHandle As SecHandle
'Alias CtxtHandle As SecHandle
Public Type CredHandle
    dwLower As LongPtr
    dwUpper As LongPtr
End Type
Public Type CtxtHandle
    dwLower As LongPtr
    dwUpper As LongPtr
End Type

'Alias SECURITY_INTEGER As LongLong

Public Function SEC_SUCCESS(ByVal value As Long) As Boolean: Return value >= 0: End Function
    
'Alias SECURITY_STRING As UNICODE_STRING
Public Type SECURITY_STRING
    Length As Integer
    MaximumLength As Integer
    Buffer As LongPtr
End Type

Public Type SecPkgInfoA
    fCapabilities As SecPackageCaps ' Capability bitmask
    wVersion As Integer ' Version of driver
    wRPCID As Integer ' ID for RPC Runtime
    cbMaxToken As Long ' Size of authentication token (max)
    Name As String  ' Text name
    Comment As String  ' Comment
End Type
Public Type SecPkgInfoW
    fCapabilities As SecPackageCaps ' Capability bitmask
    wVersion As Integer ' Version of driver
    wRPCID As Integer ' ID for RPC Runtime
    cbMaxToken As Long ' Size of authentication token (max)
    Name As LongPtr  ' Text name
    Comment As LongPtr  ' Comment
End Type
'Alias SecPkgInfo As SecPkgInfoW
Public Type SecPkgInfo
    fCapabilities As SecPackageCaps ' Capability bitmask
    wVersion As Integer ' Version of driver
    wRPCID As Integer ' ID for RPC Runtime
    cbMaxToken As Long ' Size of authentication token (max)
    Name As LongPtr  ' Text name
    Comment As LongPtr  ' Comment
End Type

Public Enum SecPackageCaps
    SECPKG_FLAG_INTEGRITY = &H00000001  ' Supports integrity on messages
    SECPKG_FLAG_PRIVACY = &H00000002  ' Supports privacy (confidentiality)
    SECPKG_FLAG_TOKEN_ONLY = &H00000004  ' Only security token needed
    SECPKG_FLAG_DATAGRAM = &H00000008  ' Datagram RPC support
    SECPKG_FLAG_CONNECTION = &H00000010  ' Connection oriented RPC support
    SECPKG_FLAG_MULTI_REQUIRED = &H00000020  ' Full 3-leg required for re-auth.
    SECPKG_FLAG_CLIENT_ONLY = &H00000040  ' Server side functionality not available
    SECPKG_FLAG_EXTENDED_ERROR = &H00000080  ' Supports extended error msgs
    SECPKG_FLAG_IMPERSONATION = &H00000100  ' Supports impersonation
    SECPKG_FLAG_ACCEPT_WIN32_NAME = &H00000200  ' Accepts Win32 names
    SECPKG_FLAG_STREAM = &H00000400  ' Supports stream semantics
    SECPKG_FLAG_NEGOTIABLE = &H00000800  ' Can be used by the negotiate package
    SECPKG_FLAG_GSS_COMPATIBLE = &H00001000  ' GSS Compatibility Available
    SECPKG_FLAG_LOGON = &H00002000  ' Supports common LsaLogonUser
    SECPKG_FLAG_ASCII_BUFFERS = &H00004000  ' Token Buffers are in ASCII
    SECPKG_FLAG_FRAGMENT = &H00008000&  ' Package can fragment to fit
    SECPKG_FLAG_MUTUAL_AUTH = &H00010000  ' Package can perform mutual authentication
    SECPKG_FLAG_DELEGATION = &H00020000  ' Package can delegate
    SECPKG_FLAG_READONLY_WITH_CHECKSUM = &H00040000  ' Package can delegate
    SECPKG_FLAG_RESTRICTED_TOKENS = &H00080000  ' Package supports restricted callers
    SECPKG_FLAG_NEGO_EXTENDER = &H00100000  ' this package extends SPNEGO, there is at most one
    SECPKG_FLAG_NEGOTIABLE2 = &H00200000  ' this package is negotiated under the NegoExtender
    SECPKG_FLAG_APPCONTAINER_PASSTHROUGH = &H00400000  ' this package receives all calls from appcontainer apps
    SECPKG_FLAG_APPCONTAINER_CHECKS = &H00800000  ' this package receives calls from appcontainer apps
'  if the following checks succeed
'  1. Caller has domain auth capability or
'  2. Target is a proxy server or
'  3. The caller has supplied creds
    SECPKG_FLAG_CREDENTIAL_ISOLATION_ENABLED = &H01000000  ' this package is running with Credential Guard enabled
    SECPKG_FLAG_APPLY_LOOPBACK = &H02000000  ' this package supports reliable detection of loopback
'  1.) The client and server see the same sequence of tokens
'  2.) The server enforces a unique exchange for each
'      non-anonymous authentication. (Replay detection)
End Enum

Public Const SECPKG_ID_NONE = &HFFFF&

Public Enum SecPackageCallFlags
    SECPKG_CALLFLAGS_APPCONTAINER = &H00000001
    SECPKG_CALLFLAGS_APPCONTAINER_AUTHCAPABLE = &H00000002
    SECPKG_CALLFLAGS_FORCE_SUPPLIED = &H00000004
    SECPKG_CALLFLAGS_APPCONTAINER_UPNCAPABLE = &H00000008
End Enum

Public Enum SecPackageBufferTypes
    SECBUFFER_EMPTY = 0  ' Undefined, replaced by provider
    SECBUFFER_DATA = 1  ' Packet data
    SECBUFFER_TOKEN = 2  ' Security token
    SECBUFFER_PKG_PARAMS = 3  ' Package specific parameters
    SECBUFFER_MISSING = 4  ' Missing Data indicator
    SECBUFFER_EXTRA = 5  ' Extra data
    SECBUFFER_STREAM_TRAILER = 6  ' Security Trailer
    SECBUFFER_STREAM_HEADER = 7  ' Security Header
    SECBUFFER_NEGOTIATION_INFO = 8  ' Hints from the negotiation pkg
    SECBUFFER_PADDING = 9  ' non-data padding
    SECBUFFER_STREAM = 10  ' whole encrypted message
    SECBUFFER_MECHLIST = 11
    SECBUFFER_MECHLIST_SIGNATURE = 12
    SECBUFFER_TARGET = 13  ' obsolete
    SECBUFFER_CHANNEL_BINDINGS = 14
    SECBUFFER_CHANGE_PASS_RESPONSE = 15
    SECBUFFER_TARGET_HOST = 16
    SECBUFFER_ALERT = 17
    SECBUFFER_APPLICATION_PROTOCOLS = 18  ' Lists of application protocol IDs, one per negotiation extension
    SECBUFFER_SRTP_PROTECTION_PROFILES = 19  ' List of SRTP protection profiles, in descending order of preference
    SECBUFFER_SRTP_MASTER_KEY_IDENTIFIER = 20  ' SRTP master key identifier
    SECBUFFER_TOKEN_BINDING = 21  ' Supported Token Binding protocol version and key parameters
    SECBUFFER_PRESHARED_KEY = 22  ' Preshared key
    SECBUFFER_PRESHARED_KEY_IDENTITY = 23  ' Preshared key identity
    SECBUFFER_DTLS_MTU = 24  ' DTLS path MTU setting
    SECBUFFER_SEND_GENERIC_TLS_EXTENSION = 25  ' Buffer for sending generic TLS extensions.
    SECBUFFER_SUBSCRIBE_GENERIC_TLS_EXTENSION = 26  ' Buffer for subscribing to generic TLS extensions.
    SECBUFFER_FLAGS = 27  ' ISC/ASC REQ Flags
    SECBUFFER_TRAFFIC_SECRETS = 28  ' Message sequence lengths and corresponding traffic secrets.
    SECBUFFER_CERTIFICATE_REQUEST_CONTEXT = 29  ' TLS 1.3 certificate request context.
    SECBUFFER_CHANNEL_BINDINGS_RESULT = 30  ' Output buffer for Channel Bindings Audit
    SECBUFFER_ATTRMASK = &HF0000000
    SECBUFFER_READONLY = &H80000000  ' Buffer is read-only, no checksum
    SECBUFFER_READONLY_WITH_CHECKSUM = &H10000000  ' Buffer is read-only, and checksummed
    SECBUFFER_RESERVED = &H60000000  ' Flags reserved to security system
End Enum

Public Type SecBuffer
    cbBuffer As Long ' Size of the buffer, in bytes
    BufferType As SecPackageBufferTypes ' Type of the buffer  
    pvBuffer As LongPtr
End Type

Public Enum SecBufferVersions
	SECBUFFER_VERSION
End Enum

Public Type SecBufferDesc
    ulVersion As SecBufferVersions ' Version number
    cBuffers As Long ' Number of buffers
    pBuffers As LongPtr ' Pointer to array of buffers
End Type

Public Type SEC_NEGOTIATION_INFO
    Size As Long ' Size of this structure
    NameLength As Long ' Length of name hint
    Name As LongPtr  ' Name hint
    Reserved As LongPtr 'void*  ' Reserved
End Type

Public Type SEC_CHANNEL_BINDINGS
    dwInitiatorAddrType As Long
    cbInitiatorLength As Long
    dwInitiatorOffset As Long
    dwAcceptorAddrType As Long
    cbAcceptorLength As Long
    dwAcceptorOffset As Long
    cbApplicationDataLength As Long
    dwApplicationDataOffset As Long
End Type

Public Const SEC_CHANNEL_BINDINGS_EX_MAGIC = &H58454243 ' 'XEBC'

Public Type SEC_CHANNEL_BINDINGS_EX
    magicNumber As Long ' contains SEC_CHANNEL_BINDINGS_VERSION_2.  distinguish ex buffer from normal channel bindings buffer. Shouldn't collide with any of assigned dwInitiatorAddrType values
    flags As SecChannelBindingsFlags ' audit flag is set to indicate if audit is needed 
    cbHeaderLength As Long
    cbStructureLength As Long
    dwInitiatorAddrType As Long
    cbInitiatorLength As Long
    dwInitiatorOffset As Long
    dwAcceptorAddrType As Long
    cbAcceptorLength As Long
    dwAcceptorOffset As Long
    cbApplicationDataLength As Long
    dwApplicationDataOffset As Long
End Type

Public Enum SecChannelBindingsFlags
    SEC_CHANNEL_BINDINGS_AUDIT_BINDINGS = &H1
    SEC_CHANNEL_BINDINGS_VALID_FLAGS = SEC_CHANNEL_BINDINGS_AUDIT_BINDINGS
End Enum

Public Enum SecChannelBindingsResultFlags
    SEC_CHANNEL_BINDINGS_RESULT_CLIENT_SUPPORT = &H1  ' Auth package indicates client versions should support bindings
    SEC_CHANNEL_BINDINGS_RESULT_ABSENT = &H2  ' The bindings are omitted or all zeroes
    SEC_CHANNEL_BINDINGS_RESULT_NOTVALID_MISMATCH = &H4  ' The channel binding hash was incorrect
    SEC_CHANNEL_BINDINGS_RESULT_NOTVALID_MISSING = &H8  ' Missing channel bindings are not allowed for this client
    SEC_CHANNEL_BINDINGS_RESULT_VALID_MATCHED = &H10  ' The client and server bindings match
    SEC_CHANNEL_BINDINGS_RESULT_VALID_PROXY = &H20  ' ASC_REQ_PROXY_BINDINGS required the client to provide a binding
    SEC_CHANNEL_BINDINGS_RESULT_VALID_MISSING = &H40  ' Client permitted by ASC_REQ_ALLOW_MISSING_BINDINGS
    SEC_CHANNEL_BINDINGS_RESULT_VALID = (SEC_CHANNEL_BINDINGS_RESULT_VALID_MATCHED Or SEC_CHANNEL_BINDINGS_RESULT_VALID_PROXY Or SEC_CHANNEL_BINDINGS_RESULT_VALID_MISSING)
    SEC_CHANNEL_BINDINGS_RESULT_NOTVALID = (SEC_CHANNEL_BINDINGS_RESULT_NOTVALID_MISMATCH Or SEC_CHANNEL_BINDINGS_RESULT_NOTVALID_MISSING)
End Enum
Public Type SEC_CHANNEL_BINDINGS_RESULT
    flags As SecChannelBindingsResultFlags
End Type

Public Enum SEC_APPLICATION_PROTOCOL_NEGOTIATION_EXT
    SecApplicationProtocolNegotiationExt_None
    SecApplicationProtocolNegotiationExt_NPN
    SecApplicationProtocolNegotiationExt_ALPN
End Enum

[Description("⚠️ **WARNING:** This type uses a buffer guess for a C-style array; careful specifying size.")]
Public Type SEC_APPLICATION_PROTOCOL_LIST
    ProtoNegoExt As SEC_APPLICATION_PROTOCOL_NEGOTIATION_EXT ' Protocol negotiation extension type to use with this list of protocols
    ProtocolListSize As Integer ' Size in bytes of the protocol ID list
    ProtocolList(4095) As Byte ' 8-bit length-prefixed application protocol IDs, most preferred first
End Type

[Description("⚠️ **WARNING:** This type uses a buffer guess for a C-style array; careful specifying size.")]
Public Type SEC_APPLICATION_PROTOCOLS
    ProtocolListsSize As Long ' Size in bytes of the protocol ID lists array
    ProtocolLists(99) As SEC_APPLICATION_PROTOCOL_LIST ' Array of protocol ID lists
End Type

[Description("⚠️ **WARNING:** This type uses a buffer guess for a C-style array; careful specifying size.")]
Public Type SEC_SRTP_PROTECTION_PROFILES
    ProfilesSize As Integer ' Size in bytes of the SRTP protection profiles array
    ProfilesList(1023) As Integer ' Array of SRTP protection profiles
End Type

[Description("⚠️ **WARNING:** This type uses a buffer guess for a C-style array; careful specifying size.")]
Public Type SEC_SRTP_MASTER_KEY_IDENTIFIER
    MasterKeyIdentifierSize As Byte ' Size in bytes of the SRTP master key identifier
    MasterKeyIdentifier(4095) As Byte ' SRTP master key identifier
End Type

[Description("⚠️ **WARNING:** This type uses a buffer guess for a C-style array; careful specifying size.")]
Public Type SEC_TOKEN_BINDING
    MajorVersion As Byte ' Supported major version of the Token Binding protocol
    MinorVersion As Byte ' Supported minor version of the Token Binding protocol
    KeyParametersSize As Integer ' Size in bytes of the Token Binding key parameter IDs array
    KeyParameters(99) As Byte ' Token Binding key parameter IDs, most preferred first
End Type

[Description("⚠️ **WARNING:** This type uses a buffer guess for a C-style array; careful specifying size.")]
Public Type SEC_PRESHAREDKEY
    KeySize As Integer ' Size in bytes of the PSK
    Key(4095) As Byte ' PSK
End Type

[Description("⚠️ **WARNING:** This type uses a buffer guess for a C-style array; careful specifying size.")]
Public Type SEC_PRESHAREDKEY_IDENTITY
    KeyIdentitySize As Integer ' Size in bytes of the PSK Identity
    KeyIdentity(4095) As Byte ' PSK Identity
End Type

Public Type SEC_DTLS_MTU
    PathMTU As Integer ' Path MTU for the connection
End Type

Public Type SEC_FLAGS
    Flags As LongLong ' The caller sets ISC/ASC REQ flags; the lower 32 bits are reserved, must be set to 0.
End Type

[Description("⚠️ **WARNING:** This type uses a buffer guess for a C-style array; careful specifying size.")]
Public Type SEC_CERTIFICATE_REQUEST_CONTEXT
    cbCertificateRequestContext As Byte ' Size in bytes of the rgCertificateRequestContext array.
    rgCertificateRequestContext(4095) As Byte ' The TLS 1.3 certificate request context.
End Type

Public Enum SEC_TRAFFIC_SECRET_TYPE
    SecTrafficSecret_None
    SecTrafficSecret_Client
    SecTrafficSecret_Server
End Enum

Public Const SZ_ALG_MAX_SIZE = 64
[Description("⚠️ **WARNING:** This type uses a buffer guess for a C-style array; careful specifying size.")]
Public Type SEC_TRAFFIC_SECRETS
    SymmetricAlgId(0 To (SZ_ALG_MAX_SIZE - 1)) As Integer ' Negotiated symmetric key algorithm. e.g. BCRYPT_AES_ALGORITHM.
    ChainingMode(0 To (SZ_ALG_MAX_SIZE - 1)) As Integer ' Negotiated symmetric key algorithm chaining mode. e.g. BCRYPT_CHAIN_MODE_GCM or BCRYPT_CHAIN_MODE_CCM.
    HashAlgId(0 To (SZ_ALG_MAX_SIZE - 1)) As Integer ' Negotiated hash algorithm. e.g. BCRYPT_SHA256_ALGORITHM or BCRYPT_SHA384_ALGORITHM.
    KeySize As Integer ' Size in bytes of the symmetric key to derive from this traffic secret.
    IvSize As Integer ' Size in bytes of the IV to derive from this traffic secret.
    MsgSequenceStart As Integer ' Offset of the first byte of the TLS message sequence to be protected with a key derived from TrafficSecret. Zero to indicate the first byte of the buffer.
    MsgSequenceEnd As Integer ' Offset of the last byte of the TLS message sequence to be protected with a key derived from TrafficSecret. Zero if the secret is for the encryption of application data or decryption of incoming records.
    TrafficSecretType As SEC_TRAFFIC_SECRET_TYPE ' Type of traffic secret from the TRAFFIC_SECRET_TYPE enumeration.
    TrafficSecretSize As Integer ' Size in bytes of the traffic secret.
    TrafficSecret(0 To 4095) As Byte ' Traffic secret of type TrafficSecretType, TrafficSecretSize bytes long, used to derive write key and IV for message protection.
End Type

Public Enum SecurityDataRepConstants
    SECURITY_NATIVE_DREP = &H00000010
    SECURITY_NETWORK_DREP = &H00000000
End Enum

Public Enum SecurityCredentialUseFlags
    SECPKG_CRED_INBOUND = &H00000001
    SECPKG_CRED_OUTBOUND = &H00000002
    SECPKG_CRED_BOTH = &H00000003
    SECPKG_CRED_DEFAULT = &H00000004
    SECPKG_CRED_RESERVED = &HF0000000
'   SSP SHOULD prompt the user for credentials/consent, independent
'   of whether credentials to be used are the 'logged on' credentials
'   or retrieved from credman.
'   An SSP may choose not to prompt, however, in circumstances determined
'   by the SSP.
    SECPKG_CRED_AUTOLOGON_RESTRICTED = &H00000010
'  auth will always fail, ISC() is called to process policy data only
    SECPKG_CRED_PROCESS_POLICY_ONLY = &H00000020
End Enum

Public Enum SecurityInitContextReqFlags
    ISC_REQ_DELEGATE = &H00000001
    ISC_REQ_MUTUAL_AUTH = &H00000002
    ISC_REQ_REPLAY_DETECT = &H00000004
    ISC_REQ_SEQUENCE_DETECT = &H00000008
    ISC_REQ_CONFIDENTIALITY = &H00000010
    ISC_REQ_USE_SESSION_KEY = &H00000020
    ISC_REQ_PROMPT_FOR_CREDS = &H00000040
    ISC_REQ_USE_SUPPLIED_CREDS = &H00000080
    ISC_REQ_ALLOCATE_MEMORY = &H00000100
    ISC_REQ_USE_DCE_STYLE = &H00000200
    ISC_REQ_DATAGRAM = &H00000400
    ISC_REQ_CONNECTION = &H00000800
    ISC_REQ_CALL_LEVEL = &H00001000
    ISC_REQ_FRAGMENT_SUPPLIED = &H00002000
    ISC_REQ_EXTENDED_ERROR = &H00004000
    ISC_REQ_STREAM = &H00008000&
    ISC_REQ_INTEGRITY = &H00010000
    ISC_REQ_IDENTIFY = &H00020000
    ISC_REQ_NULL_SESSION = &H00040000
    ISC_REQ_MANUAL_CRED_VALIDATION = &H00080000
    ISC_REQ_RESERVED1 = &H00100000
    ISC_REQ_FRAGMENT_TO_FIT = &H00200000
'  This exists only in Windows Vista and greater
    ISC_REQ_FORWARD_CREDENTIALS = &H00400000
    ISC_REQ_NO_INTEGRITY = &H00800000  ' honored only by SPNEGO
    ISC_REQ_USE_HTTP_STYLE = &H01000000
    ISC_REQ_UNVERIFIED_TARGET_NAME = &H20000000
    ISC_REQ_CONFIDENTIALITY_ONLY = &H40000000  ' honored by SPNEGO/Kerberos
End Enum
Public Const ISC_REQ_MESSAGES As LongLong = &H0000000100000000  ' Disables the TLS 1.3+ record layer and causes the security context to consume and produce cleartext TLS messages, rather than records.
'  Request that schannel perform server cert chain validation without failing the handshake on errors (deferred),
'  same as SCH_CRED_DEFERRED_CRED_VALIDATION except applies to context not credential handle.
Public Const ISC_REQ_DEFERRED_CRED_VALIDATION As LongLong = &H0000000200000000
'  Prevents the client sending the post_handshake_auth extension in the TLS 1.3 Client Hello.
Public Const ISC_REQ_NO_POST_HANDSHAKE_AUTH As LongLong = &H0000000400000000
'  Request TLS 1.3+ session ticket reuse. Passive observers may be able to track the TLS client across networks.
Public Const ISC_REQ_REUSE_SESSION_TICKETS As LongLong = &H0000000800000000

Public Enum SecurityInitContextRetFlags
    ISC_RET_DELEGATE = &H00000001
    ISC_RET_MUTUAL_AUTH = &H00000002
    ISC_RET_REPLAY_DETECT = &H00000004
    ISC_RET_SEQUENCE_DETECT = &H00000008
    ISC_RET_CONFIDENTIALITY = &H00000010
    ISC_RET_USE_SESSION_KEY = &H00000020
    ISC_RET_USED_COLLECTED_CREDS = &H00000040
    ISC_RET_USED_SUPPLIED_CREDS = &H00000080
    ISC_RET_ALLOCATED_MEMORY = &H00000100
    ISC_RET_USED_DCE_STYLE = &H00000200
    ISC_RET_DATAGRAM = &H00000400
    ISC_RET_CONNECTION = &H00000800
    ISC_RET_INTERMEDIATE_RETURN = &H00001000
    ISC_RET_CALL_LEVEL = &H00002000
    ISC_RET_EXTENDED_ERROR = &H00004000
    ISC_RET_STREAM = &H00008000&
    ISC_RET_INTEGRITY = &H00010000
    ISC_RET_IDENTIFY = &H00020000
    ISC_RET_NULL_SESSION = &H00040000
    ISC_RET_MANUAL_CRED_VALIDATION = &H00080000
    ISC_RET_RESERVED1 = &H00100000
    ISC_RET_FRAGMENT_ONLY = &H00200000
'  This exists only in Windows Vista and greater
    ISC_RET_FORWARD_CREDENTIALS = &H00400000
    ISC_RET_USED_HTTP_STYLE = &H01000000
    ISC_RET_NO_ADDITIONAL_TOKEN = &H02000000  ' *INTERNAL*
    ISC_RET_REAUTHENTICATION = &H08000000  ' *INTERNAL*
    ISC_RET_CONFIDENTIALITY_ONLY = &H40000000  ' honored by SPNEGO/Kerberos
End Enum
Public Const ISC_RET_MESSAGES As LongLong = &H0000000100000000  ' Indicates that the TLS 1.3+ record layer is disabled, and the security context consumes and produces cleartext TLS messages, rather than records.
Public Const ISC_RET_DEFERRED_CRED_VALIDATION As LongLong = &H0000000200000000  ' Indicates that SCH_CRED_DEFERRED_CRED_VALIDATION/ISC_REQ_DEFERRED_CRED_VALIDATION request will be honored.
Public Const ISC_RET_NO_POST_HANDSHAKE_AUTH As LongLong = &H0000000400000000  ' Indicates that the TLS 1.3 Client Hello will not contain the post_handshake_auth extension.
Public Const ISC_RET_REUSE_SESSION_TICKETS As LongLong = &H0000000800000000  ' Indicates that the TLS 1.3+ client may reuse session tickets.

Public Enum SecurityAscReqFlags
    ASC_REQ_DELEGATE = &H00000001
    ASC_REQ_MUTUAL_AUTH = &H00000002
    ASC_REQ_REPLAY_DETECT = &H00000004
    ASC_REQ_SEQUENCE_DETECT = &H00000008
    ASC_REQ_CONFIDENTIALITY = &H00000010
    ASC_REQ_USE_SESSION_KEY = &H00000020
    ASC_REQ_SESSION_TICKET = &H00000040
    ASC_REQ_ALLOCATE_MEMORY = &H00000100
    ASC_REQ_USE_DCE_STYLE = &H00000200
    ASC_REQ_DATAGRAM = &H00000400
    ASC_REQ_CONNECTION = &H00000800
    ASC_REQ_CALL_LEVEL = &H00001000
    ASC_REQ_FRAGMENT_SUPPLIED = &H00002000
    ASC_REQ_EXTENDED_ERROR = &H00008000&
    ASC_REQ_STREAM = &H00010000
    ASC_REQ_INTEGRITY = &H00020000
    ASC_REQ_LICENSING = &H00040000
    ASC_REQ_IDENTIFY = &H00080000
    ASC_REQ_ALLOW_NULL_SESSION = &H00100000
    ASC_REQ_ALLOW_NON_USER_LOGONS = &H00200000
    ASC_REQ_ALLOW_CONTEXT_REPLAY = &H00400000
    ASC_REQ_FRAGMENT_TO_FIT = &H00800000
    ASC_REQ_NO_TOKEN = &H01000000
    ASC_REQ_PROXY_BINDINGS = &H04000000
'       SSP_RET_REAUTHENTICATION        0x08000000  // *INTERNAL*
    ASC_REQ_ALLOW_MISSING_BINDINGS = &H10000000
End Enum
Public Const ASC_REQ_MESSAGES As LongLong = &H0000000100000000  ' Disables the TLS 1.3+ record layer and causes the security context to consume and produce cleartext TLS messages, rather than records.
'  Request that the TLS 1.3+ server accept reused session tickets referencing cached TLS sessions.
Public Const ASC_REQ_REUSE_SESSION_TICKETS As LongLong = &H0000000800000000

Public Enum SecurityAscRetFlags
    ASC_RET_DELEGATE = &H00000001
    ASC_RET_MUTUAL_AUTH = &H00000002
    ASC_RET_REPLAY_DETECT = &H00000004
    ASC_RET_SEQUENCE_DETECT = &H00000008
    ASC_RET_CONFIDENTIALITY = &H00000010
    ASC_RET_USE_SESSION_KEY = &H00000020
    ASC_RET_SESSION_TICKET = &H00000040
    ASC_RET_ALLOCATED_MEMORY = &H00000100
    ASC_RET_USED_DCE_STYLE = &H00000200
    ASC_RET_DATAGRAM = &H00000400
    ASC_RET_CONNECTION = &H00000800
    ASC_RET_CALL_LEVEL = &H00002000  ' skipped 1000 to be like ISC_
    ASC_RET_THIRD_LEG_FAILED = &H00004000
    ASC_RET_EXTENDED_ERROR = &H00008000&
    ASC_RET_STREAM = &H00010000
    ASC_RET_INTEGRITY = &H00020000
    ASC_RET_LICENSING = &H00040000
    ASC_RET_IDENTIFY = &H00080000
    ASC_RET_NULL_SESSION = &H00100000
    ASC_RET_ALLOW_NON_USER_LOGONS = &H00200000
    ASC_RET_ALLOW_CONTEXT_REPLAY = &H00400000  ' deprecated - don't use this flag!!!
    ASC_RET_FRAGMENT_ONLY = &H00800000
    ASC_RET_NO_TOKEN = &H01000000
    ASC_RET_NO_ADDITIONAL_TOKEN = &H02000000  ' *INTERNAL*
'       SSP_RET_REAUTHENTICATION        0x08000000  // *INTERNAL*
End Enum
Public Const ASC_RET_MESSAGES As LongLong = &H0000000100000000  ' Indicates that the TLS 1.3+ record layer is disabled, and the security context consumes and produces cleartext TLS messages, rather than records.
Public Const ASC_RET_REUSE_SESSION_TICKETS As LongLong = &H0000000800000000  ' Indicates that the TLS 1.3+ server will allow session ticket reuse.

Public Enum SecurityCredentialAttributes
    SECPKG_CRED_ATTR_NAMES = 1
    SECPKG_CRED_ATTR_SSI_PROVIDER = 2
    SECPKG_CRED_ATTR_KDC_PROXY_SETTINGS = 3
    SECPKG_CRED_ATTR_CERT = 4
    SECPKG_CRED_ATTR_PAC_BYPASS = 5
End Enum

Public Type SecPkgCredentials_NamesA
    sUserName As String
End Type
Public Type SecPkgCredentials_NamesW
    sUserName As LongPtr
End Type
'Alias SecPkgCredentials_Names As SecPkgCredentials_NamesW
Public Type SecPkgCredentials_Names
    sUserName As LongPtr
End Type

Public Type SecPkgCredentials_SSIProviderA
    sProviderName As String
    ProviderInfoLength As Long
    ProviderInfo As LongPtr
End Type
Public Type SecPkgCredentials_SSIProviderW
    sProviderName As LongPtr
    ProviderInfoLength As Long
    ProviderInfo As LongPtr
End Type
'Alias SecPkgCredentials_SSIProvider As SecPkgCredentials_SSIProviderW
Public Type SecPkgCredentials_SSIProvider
    sProviderName As LongPtr
    ProviderInfoLength As Long
    ProviderInfo As LongPtr
End Type

Public Enum SecPkgKdcVersions
	KDC_PROXY_SETTINGS_V1 = 1
End Enum
Public Enum SecPkgKdcFlags
	KDC_PROXY_SETTINGS_FLAGS_FORCEPROXY = &H1
End Enum
Public Type SecPkgCredentials_KdcProxySettingsW
    Version As SecPkgKdcVersions ' KDC_PROXY_SETTINGS_V1
    Flags As SecPkgKdcFlags ' KDC_PROXY_SETTINGS_FLAGS_*
    ProxyServerOffset As Integer ' ProxyServer, optional
    ProxyServerLength As Integer
    ClientTlsCredOffset As Integer ' ClientTlsCred, optional
    ClientTlsCredLength As Integer
End Type

Public Enum SecPkgAttributes
    SECPKG_ATTR_SIZES = 0
    SECPKG_ATTR_NAMES = 1
    SECPKG_ATTR_LIFESPAN = 2
    SECPKG_ATTR_DCE_INFO = 3
    SECPKG_ATTR_STREAM_SIZES = 4
    SECPKG_ATTR_KEY_INFO = 5
    SECPKG_ATTR_AUTHORITY = 6
    SECPKG_ATTR_PROTO_INFO = 7
    SECPKG_ATTR_PASSWORD_EXPIRY = 8
    SECPKG_ATTR_SESSION_KEY = 9
    SECPKG_ATTR_PACKAGE_INFO = 10
    SECPKG_ATTR_USER_FLAGS = 11
    SECPKG_ATTR_NEGOTIATION_INFO = 12
    SECPKG_ATTR_NATIVE_NAMES = 13
    SECPKG_ATTR_FLAGS = 14
'  These attributes exist only in Win XP and greater
    SECPKG_ATTR_USE_VALIDATED = 15
    SECPKG_ATTR_CREDENTIAL_NAME = 16
    SECPKG_ATTR_TARGET_INFORMATION = 17
    SECPKG_ATTR_ACCESS_TOKEN = 18
'  These attributes exist only in Win2K3 and greater
    SECPKG_ATTR_TARGET = 19
    SECPKG_ATTR_AUTHENTICATION_ID = 20
'  These attributes exist only in Win2K3SP1 and greater
    SECPKG_ATTR_LOGOFF_TIME = 21
'  win7 or greater
    SECPKG_ATTR_NEGO_KEYS = 22
    SECPKG_ATTR_PROMPTING_NEEDED = 24
    SECPKG_ATTR_UNIQUE_BINDINGS = 25
    SECPKG_ATTR_ENDPOINT_BINDINGS = 26
    SECPKG_ATTR_CLIENT_SPECIFIED_TARGET = 27
    SECPKG_ATTR_LAST_CLIENT_TOKEN_STATUS = 30
    SECPKG_ATTR_NEGO_PKG_INFO = 31  ' contains nego info of packages
    SECPKG_ATTR_NEGO_STATUS = 32  ' contains the last error
    SECPKG_ATTR_CONTEXT_DELETED = 33  ' a context has been deleted
'  win8 or greater
    SECPKG_ATTR_DTLS_MTU = 34
    SECPKG_ATTR_DATAGRAM_SIZES = SECPKG_ATTR_STREAM_SIZES
    SECPKG_ATTR_SUBJECT_SECURITY_ATTRIBUTES = 128
'  win8.1 or greater
    SECPKG_ATTR_APPLICATION_PROTOCOL = 35
'  win10 or greater
    SECPKG_ATTR_NEGOTIATED_TLS_EXTENSIONS = 36
    SECPKG_ATTR_IS_LOOPBACK = 37  ' indicates authentication to localhost
End Enum

Public Type SecPkgContext_SubjectAttributes
    AttributeInfo As LongPtr 'void* ' contains a PAUTHZ_SECURITY_ATTRIBUTES_INFORMATION structure
End Type

Public Enum SecPkgAttributeNegoInfoFlags
    SECPKG_ATTR_NEGO_INFO_FLAG_NO_KERBEROS = &H1
    SECPKG_ATTR_NEGO_INFO_FLAG_NO_NTLM = &H2
End Enum

Public Enum SECPKG_CRED_CLASS
    SecPkgCredClass_None = 0 ' no creds
    SecPkgCredClass_Ephemeral = 10 ' logon creds
    SecPkgCredClass_PersistedGeneric = 20 ' saved creds, not target specific
    SecPkgCredClass_PersistedSpecific = 30 ' saved creds, target specific
    SecPkgCredClass_Explicit = 40 ' explicitly supplied creds
End Enum
Public Type SecPkgContext_CredInfo
    CredClass As SECPKG_CRED_CLASS
    IsPromptingNeeded As Long
End Type

Public Type SecPkgContext_NegoPackageInfo
    PackageMask As Long
End Type
Public Type SecPkgContext_NegoStatus
    LastStatus As Long
End Type
Public Type SecPkgContext_Sizes
    cbMaxToken As Long
    cbMaxSignature As Long
    cbBlockSize As Long
    cbSecurityTrailer As Long
End Type
Public Type SecPkgContext_StreamSizes
    cbHeader As Long
    cbTrailer As Long
    cbMaximumMessage As Long
    cBuffers As Long
    cbBlockSize As Long
End Type

' typedef SecPkgContext_StreamSizes SecPkgContext_DatagramSizes;
' Alias SecPkgContext_StreamSizes PSecPkgContext_DatagramSizes;
Public Type SecPkgContext_DatagramSizes
    cbHeader As Long
    cbTrailer As Long
    cbMaximumMessage As Long
    cBuffers As Long
    cbBlockSize As Long
End Type
Public Type SecPkgContext_NamesW
    sUserName As LongPtr
End Type

Public Enum SECPKG_ATTR_LCT_STATUS
    SecPkgAttrLastClientTokenYes
    SecPkgAttrLastClientTokenNo
    SecPkgAttrLastClientTokenMaybe
End Enum
Public Type SecPkgContext_LastClientTokenStatus
    LastClientTokenStatus As SECPKG_ATTR_LCT_STATUS
End Type

Public Type SecPkgContext_NamesA
    sUserName As String
End Type
'Alias SecPkgContext_Names As SecPkgContext_NamesW
Public Type SecPkgContext_Names
    sUserName As LongPtr
End Type
Public Type SecPkgContext_Lifespan
    tsStart As LongLong
    tsExpiry As LongLong
End Type
Public Type SecPkgContext_DceInfo
    AuthzSvc As Long
    pPac As LongPtr 'v oid*
End Type
Public Type SecPkgContext_KeyInfoA
    sSignatureAlgorithmName As String
    sEncryptAlgorithmName As String
    KeySize As Long
    SignatureAlgorithm As ALG_ID
    EncryptAlgorithm As ALG_ID
End Type
Public Type SecPkgContext_KeyInfoW
    sSignatureAlgorithmName As LongPtr
    sEncryptAlgorithmName As LongPtr
    KeySize As Long
    SignatureAlgorithm As ALG_ID
    EncryptAlgorithm As ALG_ID
End Type
Public Type SecPkgContext_KeyInfo
    sSignatureAlgorithmName As LongPtr
    sEncryptAlgorithmName As LongPtr
    KeySize As Long
    SignatureAlgorithm As ALG_ID
    EncryptAlgorithm As ALG_ID
End Type

Public Type SecPkgContext_AuthorityA
    sAuthorityName As String
End Type
Public Type SecPkgContext_AuthorityW
    sAuthorityName As LongPtr
End Type
Public Type SecPkgContext_Authority
    sAuthorityName As LongPtr
End Type

Public Type SecPkgContext_ProtoInfoA
    sProtocolName As String
    majorVersion As Long
    minorVersion As Long
End Type
Public Type SecPkgContext_ProtoInfoW
    sProtocolName As LongPtr
    majorVersion As Long
    minorVersion As Long
End Type
Public Type SecPkgContext_ProtoInfo
    sProtocolName As LongPtr
    majorVersion As Long
    minorVersion As Long
End Type

Public Type SecPkgContext_PasswordExpiry
    tsPasswordExpires As LongLong
End Type

Public Type SecPkgContext_LogoffTime
    tsLogoffTime As LongLong
End Type

Public Type SecPkgContext_SessionKey
    SessionKeyLength As Long
    SessionKey As LongPtr
End Type

Public Type SecPkgContext_NegoKeys
    KeyType As Long
    KeyLength As Integer
    KeyValue As LongPtr
    VerifyKeyType As Long
    VerifyKeyLength As Integer
    VerifyKeyValue As LongPtr
End Type

Public Type SecPkgContext_PackageInfoW
    PackageInfo As LongPtr 'PSecPkgInfoW
End Type
Public Type SecPkgContext_PackageInfoA
    PackageInfo As LongPtr 'PSecPkgInfoA
End Type
Public Type SecPkgContext_PackageInfo
    PackageInfo As LongPtr 'PSecPkgInfo
End Type

Public Type SecPkgContext_UserFlags
    UserFlags As LsaProfileUserFlags
End Type

Public Type SecPkgContext_Flags
    Flags As SecurityInitContextReqFlags
End Type

Public Type SecPkgContext_NegotiationInfoA
    PackageInfo As LongPtr 'PSecPkgInfoA
    NegotiationState As Long
End Type
Public Type SecPkgContext_NegotiationInfoW
    PackageInfo As LongPtr 'PSecPkgInfoW
    NegotiationState As Long
End Type
Public Type SecPkgContext_NegotiationInfo
    PackageInfo As LongPtr 'PSecPkgInfo 
    NegotiationState As SecPkgNegotiationStates
End Type
Public Enum SecPkgNegotiationStates
    SECPKG_NEGOTIATION_COMPLETE = 0
    SECPKG_NEGOTIATION_OPTIMISTIC = 1
    SECPKG_NEGOTIATION_IN_PROGRESS = 2
    SECPKG_NEGOTIATION_DIRECT = 3
    SECPKG_NEGOTIATION_TRY_MULTICRED = 4
End Enum

Public Type SecPkgContext_NativeNamesW
    sClientName As LongPtr
    sServerName As LongPtr
End Type
Public Type SecPkgContext_NativeNamesA
    sClientName As String
    sServerName As String
End Type
Public Type SecPkgContext_NativeNames
    sClientName As LongPtr
    sServerName As LongPtr
End Type

Public Type SecPkgContext_CredentialNameW
    CredentialType As WinCredTypes
    sCredentialName As LongPtr
End Type

Public Type SecPkgContext_CredentialNameA
    CredentialType As WinCredTypes
    sCredentialName As String
End Type
Public Type SecPkgContext_CredentialName
    CredentialType As WinCredTypes
    sCredentialName As LongPtr
End Type

Public Type SecPkgContext_AccessToken
    AccessToken As LongPtr 'void*
End Type

Public Type SecPkgContext_TargetInformation
    MarshalledTargetInfoLength As Long
    MarshalledTargetInfo As LongPtr 'unsigned char *
End Type

Public Type SecPkgContext_AuthzID
    AuthzIDLength As Long
    AuthzID As LongPtr 'char *
End Type

Public Type SecPkgContext_Target
    TargetLength As Long
    Target As LongPtr 'char *
End Type

Public Type SecPkgContext_ClientSpecifiedTarget
    sTargetName As LongPtr
End Type

Public Type SecPkgContext_Bindings
    BindingsLength As Long
    Bindings As LongPtr '*SEC_CHANNEL_BINDINGS 
End Type

Public Enum SEC_APPLICATION_PROTOCOL_NEGOTIATION_STATUS
    SecApplicationProtocolNegotiationStatus_None
    SecApplicationProtocolNegotiationStatus_Success
    SecApplicationProtocolNegotiationStatus_SelectedClientOnly
End Enum

Public Const MAX_PROTOCOL_ID_SIZE = &HFF
Public Type SecPkgContext_ApplicationProtocol
    ProtoNegoStatus As SEC_APPLICATION_PROTOCOL_NEGOTIATION_STATUS ' Application  protocol negotiation status
    ProtoNegoExt As SEC_APPLICATION_PROTOCOL_NEGOTIATION_EXT ' Protocol negotiation extension type corresponding to this protocol ID
    ProtocolIdSize As Byte ' Size in bytes of the application protocol ID
    ProtocolId(0 To (MAX_PROTOCOL_ID_SIZE - 1)) As Byte ' Byte string representing the negotiated application protocol ID
End Type

Public Type SecPkgContext_NegotiatedTlsExtensions
    ExtensionsCount As Long ' Number of negotiated TLS extensions.
    Extensions As LongPtr 'USHORT*  ' Pointer to array of 2-byte TLS extension IDs (allocated by IANA).
End Type

Public Type SECPKG_APP_MODE_INFO
    UserFunction As Long
    Argument1 As LongPtr
    Argument2 As LongPtr
    UserData As SecBuffer
    ReturnToLsa As Byte
End Type

' typedef void
' (SEC_ENTRY * SEC_GET_KEY_FN) (
    ' void * Arg,                 // Argument passed in
    ' void * Principal,           // Principal ID
    ' unsigned long KeyVer,               // Key Version
    ' void * * Key,       // Returned ptr to key
    ' SECURITY_STATUS * Status    // returned status
    ' );

Public Enum SecurityExportContextFlags
    SECPKG_CONTEXT_EXPORT_RESET_NEW = &H00000001  ' New context is reset to initial state
    SECPKG_CONTEXT_EXPORT_DELETE_OLD = &H00000002  ' Old context is deleted during export
'  This is only valid in W2K3SP1 and greater
    SECPKG_CONTEXT_EXPORT_TO_KERNEL = &H00000004  ' Context is to be transferred to the kernel
End Enum
    
Public Declare PtrSafe Function AcquireCredentialsHandleA Lib "secur32" (ByVal pszPrincipal As String, ByVal pszPackage As String, ByVal fCredentialUse As SecurityCredentialUseFlags, pvLogonId As Any, pAuthData As Any, ByVal pGetKeyFn As LongPtr, pvGetKeyArgument As Any, phCredential As CredHandle, ptsExpiry As LongLong) As Long
Public Declare PtrSafe Function AcquireCredentialsHandleW Lib "secur32" (ByVal pszPrincipal As LongPtr, ByVal pszPackage As LongPtr, ByVal fCredentialUse As SecurityCredentialUseFlags, pvLogonId As Any, pAuthData As Any, ByVal pGetKeyFn As LongPtr, pvGetKeyArgument As Any, phCredential As CredHandle, ptsExpiry As LongLong) As Long
Public DeclareWide PtrSafe Function AcquireCredentialsHandle Lib "secur32" Alias "AcquireCredentialsHandleW" (ByVal pszPrincipal As String, ByVal pszPackage As String, ByVal fCredentialUse As SecurityCredentialUseFlags, pvLogonId As Any, pAuthData As Any, ByVal pGetKeyFn As LongPtr, pvGetKeyArgument As Any, phCredential As CredHandle, ptsExpiry As LongLong) As Long

' typedef SECURITY_STATUS
' (SEC_ENTRY * ACQUIRE_CREDENTIALS_HANDLE_FN_A)(
    ' SEC_CHAR *,
    ' SEC_CHAR *,
    ' unsigned long,
    ' void *,
    ' void *,
    ' SEC_GET_KEY_FN,
    ' void *,
    ' PCredHandle,
    ' PTimeStamp);
    
Public Declare PtrSafe Function FreeCredentialsHandle Lib "secur32" (phCredential As CredHandle) As Long
Public Declare PtrSafe Function AddCredentialsA Lib "secur32" (phCredential As CredHandle, ByVal pszPrincipal As String, ByVal pszPackage As String, ByVal fCredentialUse As SecurityCredentialUseFlags, pAuthData As Any, ByVal pGetKeyFn As LongPtr, pvGetKeyArgument As Any, ptsExpiry As LongLong) As Long
Public Declare PtrSafe Function AddCredentialsW Lib "secur32" (phCredential As CredHandle, ByVal pszPrincipal As LongPtr, ByVal pszPackage As LongPtr, ByVal fCredentialUse As SecurityCredentialUseFlags, pAuthData As Any, ByVal pGetKeyFn As LongPtr, pvGetKeyArgument As Any, ptsExpiry As LongLong) As Long
Public DeclareWide PtrSafe Function AddCredentials Lib "secur32" Alias "AddCredentialsW" (phCredential As CredHandle, ByVal pszPrincipal As String, ByVal pszPackage As String, ByVal fCredentialUse As SecurityCredentialUseFlags, pAuthData As Any, ByVal pGetKeyFn As LongPtr, pvGetKeyArgument As Any, ptsExpiry As LongLong) As Long

' typedef SECURITY_STATUS
' (SEC_ENTRY * ADD_CREDENTIALS_FN_A)(
    ' PCredHandle,
    ' SEC_CHAR *,
    ' SEC_CHAR *,
    ' unsigned long,
    ' void *,
    ' SEC_GET_KEY_FN,
    ' void *,
    ' PTimeStamp);
' (SEC_ENTRY * ADD_CREDENTIALS_FN_W)(
    ' PCredHandle,
' #if ISSP_MODE == 0
    ' PSECURITY_STRING,
    ' PSECURITY_STRING,
' #else
    ' SEC_WCHAR *,
    ' SEC_WCHAR *,
' #endif
    ' unsigned long,
    ' void *,
    ' SEC_GET_KEY_FN,
    ' void *,
    ' PTimeStamp);
    
'*******************************
'KERNEL MODE ONLY CALLS OMITTED
'*******************************

Public Declare PtrSafe Function ChangeAccountPasswordA Lib "secur32" (ByVal pszPackageName As String, ByVal pszDomainName As String, ByVal pszAccountName As String, ByVal pszOldPassword As String, ByVal pszNewPassword As String, ByVal bImpersonating As Byte, ByVal dwReserved As Long, pOutput As SecBufferDesc) As Long
Public Declare PtrSafe Function ChangeAccountPasswordW Lib "secur32" (ByVal pszPackageName As LongPtr, ByVal pszDomainName As LongPtr, ByVal pszAccountName As LongPtr, ByVal pszOldPassword As LongPtr, ByVal pszNewPassword As LongPtr, ByVal bImpersonating As Byte, ByVal dwReserved As Long, pOutput As SecBufferDesc) As Long
Public Declare PtrSafe Function ChangeAccountPassword Lib "secur32" Alias "ChangeAccountPasswordW" (ByVal pszPackageName As String, ByVal pszDomainName As String, ByVal pszAccountName As String, ByVal pszOldPassword As String, ByVal pszNewPassword As String, ByVal bImpersonating As Byte, ByVal dwReserved As Long, pOutput As SecBufferDesc) As Long

' typedef SECURITY_STATUS
' (SEC_ENTRY * CHANGE_PASSWORD_FN_A)(
    ' SEC_CHAR *,
    ' SEC_CHAR *,
    ' SEC_CHAR *,
    ' SEC_CHAR *,
    ' SEC_CHAR *,
    ' BOOLEAN,
    ' unsigned long,
    ' PSecBufferDesc
    ' );
    
    ' typedef SECURITY_STATUS
    ' (SEC_ENTRY * CHANGE_PASSWORD_FN_W)(
        ' SEC_WCHAR *,
        ' SEC_WCHAR *,
        ' SEC_WCHAR *,
        ' SEC_WCHAR *,
        ' SEC_WCHAR *,
        ' BOOLEAN,
        ' unsigned long,
        ' PSecBufferDesc
        ' );
        
Public Declare PtrSafe Function InitializeSecurityContextA Lib "secur32" (phCredential As CredHandle, phContext As CtxtHandle, ByVal pszTargetName As String, ByVal fContextReq As SecurityInitContextReqFlags, ByVal Reserved1 As Long, ByVal TargetDataRep As SecurityDataRepConstants, pInput As SecBufferDesc, ByVal Reserved2 As Long, phNewContext As CtxtHandle, pOutput As SecBufferDesc, pfContextAttr As SecurityInitContextRetFlags, ptsExpiry As LongLong) As Long
Public Declare PtrSafe Function InitializeSecurityContextW Lib "secur32" (phCredential As CredHandle, phContext As CtxtHandle, ByVal pszTargetName As LongPtr, ByVal fContextReq As SecurityInitContextReqFlags, ByVal Reserved1 As Long, ByVal TargetDataRep As SecurityDataRepConstants, pInput As SecBufferDesc, ByVal Reserved2 As Long, phNewContext As CtxtHandle, pOutput As SecBufferDesc, pfContextAttr As SecurityInitContextRetFlags, ptsExpiry As LongLong) As Long
Public DeclareWide PtrSafe Function InitializeSecurityContext Lib "secur32" Alias "InitializeSecurityContextW" (phCredential As CredHandle, phContext As CtxtHandle, ByVal pszTargetName As String, ByVal fContextReq As SecurityInitContextReqFlags, ByVal Reserved1 As Long, ByVal TargetDataRep As SecurityDataRepConstants, pInput As SecBufferDesc, ByVal Reserved2 As Long, phNewContext As CtxtHandle, pOutput As SecBufferDesc, pfContextAttr As SecurityInitContextRetFlags, ptsExpiry As LongLong) As Long

' typedef SECURITY_STATUS
' (SEC_ENTRY * INITIALIZE_SECURITY_CONTEXT_FN_A)(
'     PCredHandle,
'     PCtxtHandle,
'     SEC_CHAR *,
'     unsigned long,
'     unsigned long,
'     unsigned long,
'     PSecBufferDesc,
'     unsigned long,
'     PCtxtHandle,
'     PSecBufferDesc,
'     unsigned long *,
'     PTimeStamp);
    
' typedef SECURITY_STATUS
' (SEC_ENTRY * INITIALIZE_SECURITY_CONTEXT_FN_W)(
    ' PCredHandle,
    ' PCtxtHandle,
' #if ISSP_MODE == 0
    ' PSECURITY_STRING,
' #else
    ' SEC_WCHAR *,
' #endif
    ' unsigned long,
    ' unsigned long,
    ' unsigned long,
    ' PSecBufferDesc,
    ' unsigned long,
    ' PCtxtHandle,
    ' PSecBufferDesc,
    ' unsigned long *,
    ' PTimeStamp);
    
Public Declare PtrSafe Function AcceptSecurityContext Lib "secur32" (phCredential As CredHandle, phContext As CtxtHandle, pInput As SecBufferDesc, ByVal fContextReq As SecurityAscReqFlags, ByVal TargetDataRep As SecurityDataRepConstants, phNewContext As CtxtHandle, pOutput As SecBufferDesc, pfContextAttr As SecurityAscRetFlags, ptsExpiry As LongLong) As Long
Public Declare PtrSafe Function CompleteAuthToken Lib "secur32" (phContext As CtxtHandle, pToken As SecBufferDesc) As Long
Public Declare PtrSafe Function ImpersonateSecurityContext Lib "secur32" (phContext As CtxtHandle) As Long
Public Declare PtrSafe Function RevertSecurityContext Lib "secur32" (phContext As CtxtHandle) As Long
Public Declare PtrSafe Function QuerySecurityContextToken Lib "secur32" (phContext As CtxtHandle, Token As LongPtr) As Long
Public Declare PtrSafe Function DeleteSecurityContext Lib "secur32" (phContext As CtxtHandle) As Long
Public Declare PtrSafe Function ApplyControlToken Lib "secur32" (phContext As CtxtHandle, pInput As SecBufferDesc) As Long
Public Declare PtrSafe Function QueryContextAttributesA Lib "secur32" (phContext As CtxtHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes)] ByVal ulAttribute As Long, pBuffer As Any) As Long
Public Declare PtrSafe Function QueryContextAttributesW Lib "secur32" (phContext As CtxtHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes)] ByVal ulAttribute As Long, pBuffer As Any) As Long
Public DeclareWide PtrSafe Function QueryContextAttributes Lib "sspicli" Alias "QueryContextAttributesW" (phContext As CtxtHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes)] ByVal ulAttribute As Long, pBuffer As Any) As Long
Public Declare PtrSafe Function QueryContextAttributesExA Lib "sspicli" (phContext As CtxtHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public Declare PtrSafe Function QueryContextAttributesExW Lib "sspicli" (phContext As CtxtHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public DeclareWide PtrSafe Function QueryContextAttributesEx Lib "secur32" Alias "QueryContextAttributesExW" (phContext As CtxtHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public Declare PtrSafe Function SetContextAttributesA Lib "secur32" (phContext As CtxtHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public Declare PtrSafe Function SetContextAttributesW Lib "secur32" (phContext As CtxtHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public DeclareWide PtrSafe Function SetContextAttributes Lib "secur32" Alias "SetContextAttributesW" (phContext As CtxtHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public Declare PtrSafe Function QueryCredentialsAttributesA Lib "sspicli" (phCredential As CredHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any) As Long
Public Declare PtrSafe Function QueryCredentialsAttributesW Lib "sspicli" (phCredential As CredHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any) As Long
Public DeclareWide PtrSafe Function QueryCredentialsAttributes Lib "sspicli" Alias "QueryCredentialsAttributesW" (phCredential As CredHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any) As Long
Public Declare PtrSafe Function QueryCredentialsAttributesExA Lib "secur32" (phCredential As CredHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public Declare PtrSafe Function QueryCredentialsAttributesExW Lib "secur32" (phCredential As CredHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public DeclareWide PtrSafe Function QueryCredentialsAttributesEx Lib "secur32" Alias "QueryCredentialsAttributesExW" (phCredential As CredHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public Declare PtrSafe Function SetCredentialsAttributesA Lib "secur32" (phCredential As CredHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public Declare PtrSafe Function SetCredentialsAttributesW Lib "secur32" (phCredential As CredHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public DeclareWide PtrSafe Function SetCredentialsAttributes Lib "secur32" Alias "SetCredentialsAttributesW" (phCredential As CredHandle, [TypeHint(SecPkgAttributes, SecPkgCredAttributes, SecPkgExtendedAttributes)] ByVal ulAttribute As Long, pBuffer As Any, ByVal cbBuffer As Long) As Long
Public Declare PtrSafe Function FreeContextBuffer Lib "secur32" (ByVal pvContextBuffer As LongPtr) As Long
Public Declare PtrSafe Function MakeSignature Lib "secur32" (phContext As CtxtHandle, ByVal fQOP As Long, pMessage As SecBufferDesc, ByVal MessageSeqNumber As Long) As Long
Public Declare PtrSafe Function VerifySignature Lib "secur32" (phContext As CtxtHandle, pMessage As SecBufferDesc, ByVal MessageSeqNumber As Long, pfQOP As Long) As Long

Public Enum SecurityQOPWrapFlags
    SECQOP_WRAP_NO_ENCRYPT = &H80000001
    SECQOP_WRAP_OOB_DATA = &H40000000
End Enum

Public Declare PtrSafe Function EncryptMessage Lib "secur32" (phContext As CtxtHandle, ByVal fQOP As Long, pMessage As SecBufferDesc, ByVal MessageSeqNumber As Long) As Long
Public Declare PtrSafe Function DecryptMessage Lib "secur32" (phContext As CtxtHandle, pMessage As SecBufferDesc, ByVal MessageSeqNumber As Long, pfQOP As SecurityQOPWrapFlags) As Long
Public Declare PtrSafe Function EnumerateSecurityPackagesA Lib "secur32" (pcPackages As Long, ppPackageInfo As LongPtr) As Long
Public Declare PtrSafe Function EnumerateSecurityPackagesW Lib "secur32" (pcPackages As Long, ppPackageInfo As LongPtr) As Long
Public DeclareWide PtrSafe Function EnumerateSecurityPackages Lib "secur32" Alias "EnumerateSecurityPackagesW" (pcPackages As Long, ppPackageInfo As LongPtr) As Long
Public Declare PtrSafe Function QuerySecurityPackageInfoA Lib "secur32" (ByVal pszPackageName As String, ppPackageInfo As LongPtr) As Long
Public Declare PtrSafe Function QuerySecurityPackageInfoW Lib "secur32" (ByVal pszPackageName As LongPtr, ppPackageInfo As LongPtr) As Long
Public DeclareWide PtrSafe Function QuerySecurityPackageInfo Lib "secur32" Alias "QuerySecurityPackageInfoW" (ByVal pszPackageName As String, ppPackageInfo As LongPtr) As Long

Public Enum SecDelegationType
    SecFull
    SecService
    SecTree
    SecDirectory
    SecObject
End Enum

Public Declare PtrSafe Function DelegateSecurityContext Lib "secur32" (phContext As CtxtHandle, ByVal pszTarget As String, ByVal DelegationType As SecDelegationType, pExpiry As LongLong, pPackageParameters As SecBuffer, pOutput As SecBufferDesc) As Long
Public Declare PtrSafe Function ExportSecurityContext Lib "secur32" (phContext As CtxtHandle, ByVal fFlags As SecurityExportContextFlags, pPackedContext As SecBuffer, Optional pToken As LongPtr) As Long
Public Declare PtrSafe Function ImportSecurityContextA Lib "secur32" (ByVal pszPackage As String, pPackedContext As SecBuffer, ByVal Token As LongPtr, phContext As CtxtHandle) As Long
Public Declare PtrSafe Function ImportSecurityContextW Lib "secur32" (ByVal pszPackage As LongPtr, pPackedContext As SecBuffer, ByVal Token As LongPtr, phContext As CtxtHandle) As Long
Public DeclareWide PtrSafe Function ImportSecurityContext Lib "secur32" Alias "ImportSecurityContextW" (ByVal pszPackage As String, pPackedContext As SecBuffer, ByVal Token As LongPtr, phContext As CtxtHandle) As Long

'*******************************
'KERNEL MODE ONLY CALLS OMITTED
'*******************************

Public Const SECURITY_ENTRYPOINT_ANSIW  = "InitSecurityInterfaceW"
Public Const SECURITY_ENTRYPOINT_ANSIA  = "InitSecurityInterfaceA"
Public Const SECURITY_ENTRYPOINTW  = "InitSecurityInterfaceW"   ' ntifs
Public Const SECURITY_ENTRYPOINTA  = "InitSecurityInterfaceA"
Public Const SECURITY_ENTRYPOINT16  = "INITSECURITYINTERFACEA"
Public Const SECURITY_ENTRYPOINT  = SECURITY_ENTRYPOINTW  ' ntifs
Public Const SECURITY_ENTRYPOINT_ANSI  = SECURITY_ENTRYPOINT_ANSIW

Public Declare PtrSafe Function FreeCredentialHandle Lib "secur32" Alias "FreeCredentialsHandle" (phCredential As CredHandle) As Long

Public Type SECURITY_FUNCTION_TABLE_A
    dwVersion As Long
    EnumerateSecurityPackagesW As LongPtr 'ENUMERATE_SECURITY_PACKAGES_FN_A
    QueryCredentialsAttributesW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_FN_A
    AcquireCredentialsHandleW As LongPtr 'ACQUIRE_CREDENTIALS_LongPtr_FN_A
    FreeCredentialsHandle As LongPtr 'FREE_CREDENTIALS_LongPtr_FN
    Reserved2 As LongPtr 'void*
    InitializeSecurityContextW As LongPtr 'INITIALIZE_SECURITY_CONTEXT_FN_A
    AcceptSecurityContext As LongPtr 'ACCEPT_SECURITY_CONTEXT_FN
    CompleteAuthToken As LongPtr 'COMPLETE_AUTH_TOKEN_FN
    DeleteSecurityContext As LongPtr 'DELETE_SECURITY_CONTEXT_FN
    ApplyControlToken As LongPtr 'APPLY_CONTROL_TOKEN_FN
    QueryContextAttributesW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_FN_A
    ImpersonateSecurityContext As LongPtr 'IMPERSONATE_SECURITY_CONTEXT_FN
    RevertSecurityContext As LongPtr 'REVERT_SECURITY_CONTEXT_FN
    MakeSignature As LongPtr 'MAKE_SIGNATURE_FN
    VerifySignature As LongPtr 'VERIFY_SIGNATURE_FN
    FreeContextBuffer As LongPtr 'FREE_CONTEXT_BUFFER_FN
    QuerySecurityPackageInfoW As LongPtr 'QUERY_SECURITY_PACKAGE_INFO_FN_A
    Reserved3 As LongPtr 'void
    Reserved4 As LongPtr 'void
    ExportSecurityContext As LongPtr 'EXPORT_SECURITY_CONTEXT_FN
    ImportSecurityContextW As LongPtr 'IMPORT_SECURITY_CONTEXT_FN_A
    AddCredentialsW As LongPtr 'ADD_CREDENTIALS_FN_A                
    Reserved8 As LongPtr 'void
    QuerySecurityContextToken As LongPtr 'QUERY_SECURITY_CONTEXT_TOKEN_FN
    EncryptMessage As LongPtr 'ENCRYPT_MESSAGE_FN
    DecryptMessage As LongPtr 'DECRYPT_MESSAGE_FN
    '#if OSVER(NTDDI_VERSION) > NTDDI_WIN2K
    ' Fields below this are available in OSes after w2k
    SetContextAttributesW As LongPtr 'SET_CONTEXT_ATTRIBUTES_FN_A
    '#endif // greater thean 2K
    '#if NTDDI_VERSION > NTDDI_WS03SP1
    ' Fields below this are available in OSes after W2k3SP1
    SetCredentialsAttributesW As LongPtr 'SET_CREDENTIALS_ATTRIBUTES_FN_A
    '#endif
    ChangeAccountPasswordW As LongPtr 'CHANGE_PASSInteger_FN_A
    '#else
    '    void *                      Reserved9;
    '#endif
    '#if NTDDI_VERSION > NTDDI_WINBLUE
    ' Fields below this are available in OSes after Windows 8.1
    QueryContextAttributesExW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_EX_FN_A
    QueryCredentialsAttributesExW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_EX_FN_A
    'endif
End Type
Public Type SECURITY_FUNCTION_TABLE_W
    dwVersion As Long
    EnumerateSecurityPackagesW As LongPtr 'ENUMERATE_SECURITY_PACKAGES_FN_W
    QueryCredentialsAttributesW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_FN_W
    AcquireCredentialsHandleW As LongPtr 'ACQUIRE_CREDENTIALS_LongPtr_FN_W
    FreeCredentialsHandle As LongPtr 'FREE_CREDENTIALS_LongPtr_FN
    Reserved2 As LongPtr 'void*
    InitializeSecurityContextW As LongPtr 'INITIALIZE_SECURITY_CONTEXT_FN_W
    AcceptSecurityContext As LongPtr 'ACCEPT_SECURITY_CONTEXT_FN
    CompleteAuthToken As LongPtr 'COMPLETE_AUTH_TOKEN_FN
    DeleteSecurityContext As LongPtr 'DELETE_SECURITY_CONTEXT_FN
    ApplyControlToken As LongPtr 'APPLY_CONTROL_TOKEN_FN
    QueryContextAttributesW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_FN_W
    ImpersonateSecurityContext As LongPtr 'IMPERSONATE_SECURITY_CONTEXT_FN
    RevertSecurityContext As LongPtr 'REVERT_SECURITY_CONTEXT_FN
    MakeSignature As LongPtr 'MAKE_SIGNATURE_FN
    VerifySignature As LongPtr 'VERIFY_SIGNATURE_FN
    FreeContextBuffer As LongPtr 'FREE_CONTEXT_BUFFER_FN
    QuerySecurityPackageInfoW As LongPtr 'QUERY_SECURITY_PACKAGE_INFO_FN_W
    Reserved3 As LongPtr 'void
    Reserved4 As LongPtr 'void
    ExportSecurityContext As LongPtr 'EXPORT_SECURITY_CONTEXT_FN
    ImportSecurityContextW As LongPtr 'IMPORT_SECURITY_CONTEXT_FN_W
    AddCredentialsW As LongPtr 'ADD_CREDENTIALS_FN_W                
    Reserved8 As LongPtr 'void
    QuerySecurityContextToken As LongPtr 'QUERY_SECURITY_CONTEXT_TOKEN_FN
    EncryptMessage As LongPtr 'ENCRYPT_MESSAGE_FN
    DecryptMessage As LongPtr 'DECRYPT_MESSAGE_FN
    '#if OSVER(NTDDI_VERSION) > NTDDI_WIN2K
    ' Fields below this are available in OSes after w2k
    SetContextAttributesW As LongPtr 'SET_CONTEXT_ATTRIBUTES_FN_W
    '#endif // greater thean 2K
    '#if NTDDI_VERSION > NTDDI_WS03SP1
    ' Fields below this are available in OSes after W2k3SP1
    SetCredentialsAttributesW As LongPtr 'SET_CREDENTIALS_ATTRIBUTES_FN_W
    '#endif
    ChangeAccountPasswordW As LongPtr 'CHANGE_PASSInteger_FN_W
    '#else
    '    void *                      Reserved9;
    '#endif
    '#if NTDDI_VERSION > NTDDI_WINBLUE
    ' Fields below this are available in OSes after Windows 8.1
    QueryContextAttributesExW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_EX_FN_W
    QueryCredentialsAttributesExW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_EX_FN_W
    'endif
End Type
Public Type SECURITY_FUNCTION_TABLE
    dwVersion As Long
    EnumerateSecurityPackagesW As LongPtr 'ENUMERATE_SECURITY_PACKAGES_FN_W
    QueryCredentialsAttributesW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_FN_W
    AcquireCredentialsHandleW As LongPtr 'ACQUIRE_CREDENTIALS_LongPtr_FN_W
    FreeCredentialsHandle As LongPtr 'FREE_CREDENTIALS_LongPtr_FN
    Reserved2 As LongPtr 'void*
    InitializeSecurityContextW As LongPtr 'INITIALIZE_SECURITY_CONTEXT_FN_W
    AcceptSecurityContext As LongPtr 'ACCEPT_SECURITY_CONTEXT_FN
    CompleteAuthToken As LongPtr 'COMPLETE_AUTH_TOKEN_FN
    DeleteSecurityContext As LongPtr 'DELETE_SECURITY_CONTEXT_FN
    ApplyControlToken As LongPtr 'APPLY_CONTROL_TOKEN_FN
    QueryContextAttributesW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_FN_W
    ImpersonateSecurityContext As LongPtr 'IMPERSONATE_SECURITY_CONTEXT_FN
    RevertSecurityContext As LongPtr 'REVERT_SECURITY_CONTEXT_FN
    MakeSignature As LongPtr 'MAKE_SIGNATURE_FN
    VerifySignature As LongPtr 'VERIFY_SIGNATURE_FN
    FreeContextBuffer As LongPtr 'FREE_CONTEXT_BUFFER_FN
    QuerySecurityPackageInfoW As LongPtr 'QUERY_SECURITY_PACKAGE_INFO_FN_W
    Reserved3 As LongPtr 'void
    Reserved4 As LongPtr 'void
    ExportSecurityContext As LongPtr 'EXPORT_SECURITY_CONTEXT_FN
    ImportSecurityContextW As LongPtr 'IMPORT_SECURITY_CONTEXT_FN_W
    AddCredentialsW As LongPtr 'ADD_CREDENTIALS_FN_W                
    Reserved8 As LongPtr 'void
    QuerySecurityContextToken As LongPtr 'QUERY_SECURITY_CONTEXT_TOKEN_FN
    EncryptMessage As LongPtr 'ENCRYPT_MESSAGE_FN
    DecryptMessage As LongPtr 'DECRYPT_MESSAGE_FN
    '#if OSVER(NTDDI_VERSION) > NTDDI_WIN2K
    ' Fields below this are available in OSes after w2k
    SetContextAttributesW As LongPtr 'SET_CONTEXT_ATTRIBUTES_FN_W
    '#endif // greater thean 2K
    '#if NTDDI_VERSION > NTDDI_WS03SP1
    ' Fields below this are available in OSes after W2k3SP1
    SetCredentialsAttributesW As LongPtr 'SET_CREDENTIALS_ATTRIBUTES_FN_W
    '#endif
    ChangeAccountPasswordW As LongPtr 'CHANGE_PASSInteger_FN_W
    '#else
    '    void *                      Reserved9;
    '#endif
    '#if NTDDI_VERSION > NTDDI_WINBLUE
    ' Fields below this are available in OSes after Windows 8.1
    QueryContextAttributesExW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_EX_FN_W
    QueryCredentialsAttributesExW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_EX_FN_W
    'endif
End Type

Public Type SecurityFunctionTableA
    dwVersion As Long
    EnumerateSecurityPackagesW As LongPtr 'ENUMERATE_SECURITY_PACKAGES_FN_A
    QueryCredentialsAttributesW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_FN_A
    AcquireCredentialsHandleW As LongPtr 'ACQUIRE_CREDENTIALS_LongPtr_FN_A
    FreeCredentialsHandle As LongPtr 'FREE_CREDENTIALS_LongPtr_FN
    Reserved2 As LongPtr 'void*
    InitializeSecurityContextW As LongPtr 'INITIALIZE_SECURITY_CONTEXT_FN_A
    AcceptSecurityContext As LongPtr 'ACCEPT_SECURITY_CONTEXT_FN
    CompleteAuthToken As LongPtr 'COMPLETE_AUTH_TOKEN_FN
    DeleteSecurityContext As LongPtr 'DELETE_SECURITY_CONTEXT_FN
    ApplyControlToken As LongPtr 'APPLY_CONTROL_TOKEN_FN
    QueryContextAttributesW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_FN_A
    ImpersonateSecurityContext As LongPtr 'IMPERSONATE_SECURITY_CONTEXT_FN
    RevertSecurityContext As LongPtr 'REVERT_SECURITY_CONTEXT_FN
    MakeSignature As LongPtr 'MAKE_SIGNATURE_FN
    VerifySignature As LongPtr 'VERIFY_SIGNATURE_FN
    FreeContextBuffer As LongPtr 'FREE_CONTEXT_BUFFER_FN
    QuerySecurityPackageInfoW As LongPtr 'QUERY_SECURITY_PACKAGE_INFO_FN_A
    Reserved3 As LongPtr 'void
    Reserved4 As LongPtr 'void
    ExportSecurityContext As LongPtr 'EXPORT_SECURITY_CONTEXT_FN
    ImportSecurityContextW As LongPtr 'IMPORT_SECURITY_CONTEXT_FN_A
    AddCredentialsW As LongPtr 'ADD_CREDENTIALS_FN_A                
    Reserved8 As LongPtr 'void
    QuerySecurityContextToken As LongPtr 'QUERY_SECURITY_CONTEXT_TOKEN_FN
    EncryptMessage As LongPtr 'ENCRYPT_MESSAGE_FN
    DecryptMessage As LongPtr 'DECRYPT_MESSAGE_FN
    '#if OSVER(NTDDI_VERSION) > NTDDI_WIN2K
    ' Fields below this are available in OSes after w2k
    SetContextAttributesW As LongPtr 'SET_CONTEXT_ATTRIBUTES_FN_A
    '#endif // greater thean 2K
    '#if NTDDI_VERSION > NTDDI_WS03SP1
    ' Fields below this are available in OSes after W2k3SP1
    SetCredentialsAttributesW As LongPtr 'SET_CREDENTIALS_ATTRIBUTES_FN_A
    '#endif
    ChangeAccountPasswordW As LongPtr 'CHANGE_PASSInteger_FN_A
    '#else
    '    void *                      Reserved9;
    '#endif
    '#if NTDDI_VERSION > NTDDI_WINBLUE
    ' Fields below this are available in OSes after Windows 8.1
    QueryContextAttributesExW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_EX_FN_A
    QueryCredentialsAttributesExW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_EX_FN_A
    'endif
End Type
Public Type SecurityFunctionTableW
    dwVersion As Long
    EnumerateSecurityPackagesW As LongPtr 'ENUMERATE_SECURITY_PACKAGES_FN_W
    QueryCredentialsAttributesW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_FN_W
    AcquireCredentialsHandleW As LongPtr 'ACQUIRE_CREDENTIALS_LongPtr_FN_W
    FreeCredentialsHandle As LongPtr 'FREE_CREDENTIALS_LongPtr_FN
    Reserved2 As LongPtr 'void*
    InitializeSecurityContextW As LongPtr 'INITIALIZE_SECURITY_CONTEXT_FN_W
    AcceptSecurityContext As LongPtr 'ACCEPT_SECURITY_CONTEXT_FN
    CompleteAuthToken As LongPtr 'COMPLETE_AUTH_TOKEN_FN
    DeleteSecurityContext As LongPtr 'DELETE_SECURITY_CONTEXT_FN
    ApplyControlToken As LongPtr 'APPLY_CONTROL_TOKEN_FN
    QueryContextAttributesW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_FN_W
    ImpersonateSecurityContext As LongPtr 'IMPERSONATE_SECURITY_CONTEXT_FN
    RevertSecurityContext As LongPtr 'REVERT_SECURITY_CONTEXT_FN
    MakeSignature As LongPtr 'MAKE_SIGNATURE_FN
    VerifySignature As LongPtr 'VERIFY_SIGNATURE_FN
    FreeContextBuffer As LongPtr 'FREE_CONTEXT_BUFFER_FN
    QuerySecurityPackageInfoW As LongPtr 'QUERY_SECURITY_PACKAGE_INFO_FN_W
    Reserved3 As LongPtr 'void
    Reserved4 As LongPtr 'void
    ExportSecurityContext As LongPtr 'EXPORT_SECURITY_CONTEXT_FN
    ImportSecurityContextW As LongPtr 'IMPORT_SECURITY_CONTEXT_FN_W
    AddCredentialsW As LongPtr 'ADD_CREDENTIALS_FN_W                
    Reserved8 As LongPtr 'void
    QuerySecurityContextToken As LongPtr 'QUERY_SECURITY_CONTEXT_TOKEN_FN
    EncryptMessage As LongPtr 'ENCRYPT_MESSAGE_FN
    DecryptMessage As LongPtr 'DECRYPT_MESSAGE_FN
    '#if OSVER(NTDDI_VERSION) > NTDDI_WIN2K
    ' Fields below this are available in OSes after w2k
    SetContextAttributesW As LongPtr 'SET_CONTEXT_ATTRIBUTES_FN_W
    '#endif // greater thean 2K
    '#if NTDDI_VERSION > NTDDI_WS03SP1
    ' Fields below this are available in OSes after W2k3SP1
    SetCredentialsAttributesW As LongPtr 'SET_CREDENTIALS_ATTRIBUTES_FN_W
    '#endif
    ChangeAccountPasswordW As LongPtr 'CHANGE_PASSInteger_FN_W
    '#else
    '    void *                      Reserved9;
    '#endif
    '#if NTDDI_VERSION > NTDDI_WINBLUE
    ' Fields below this are available in OSes after Windows 8.1
    QueryContextAttributesExW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_EX_FN_W
    QueryCredentialsAttributesExW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_EX_FN_W
    'endif
End Type
Public Type SecurityFunctionTable
    dwVersion As Long
    EnumerateSecurityPackagesW As LongPtr 'ENUMERATE_SECURITY_PACKAGES_FN_W
    QueryCredentialsAttributesW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_FN_W
    AcquireCredentialsHandleW As LongPtr 'ACQUIRE_CREDENTIALS_LongPtr_FN_W
    FreeCredentialsHandle As LongPtr 'FREE_CREDENTIALS_LongPtr_FN
    Reserved2 As LongPtr 'void*
    InitializeSecurityContextW As LongPtr 'INITIALIZE_SECURITY_CONTEXT_FN_W
    AcceptSecurityContext As LongPtr 'ACCEPT_SECURITY_CONTEXT_FN
    CompleteAuthToken As LongPtr 'COMPLETE_AUTH_TOKEN_FN
    DeleteSecurityContext As LongPtr 'DELETE_SECURITY_CONTEXT_FN
    ApplyControlToken As LongPtr 'APPLY_CONTROL_TOKEN_FN
    QueryContextAttributesW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_FN_W
    ImpersonateSecurityContext As LongPtr 'IMPERSONATE_SECURITY_CONTEXT_FN
    RevertSecurityContext As LongPtr 'REVERT_SECURITY_CONTEXT_FN
    MakeSignature As LongPtr 'MAKE_SIGNATURE_FN
    VerifySignature As LongPtr 'VERIFY_SIGNATURE_FN
    FreeContextBuffer As LongPtr 'FREE_CONTEXT_BUFFER_FN
    QuerySecurityPackageInfoW As LongPtr 'QUERY_SECURITY_PACKAGE_INFO_FN_W
    Reserved3 As LongPtr 'void
    Reserved4 As LongPtr 'void
    ExportSecurityContext As LongPtr 'EXPORT_SECURITY_CONTEXT_FN
    ImportSecurityContextW As LongPtr 'IMPORT_SECURITY_CONTEXT_FN_W
    AddCredentialsW As LongPtr 'ADD_CREDENTIALS_FN_W                
    Reserved8 As LongPtr 'void
    QuerySecurityContextToken As LongPtr 'QUERY_SECURITY_CONTEXT_TOKEN_FN
    EncryptMessage As LongPtr 'ENCRYPT_MESSAGE_FN
    DecryptMessage As LongPtr 'DECRYPT_MESSAGE_FN
    '#if OSVER(NTDDI_VERSION) > NTDDI_WIN2K
    ' Fields below this are available in OSes after w2k
    SetContextAttributesW As LongPtr 'SET_CONTEXT_ATTRIBUTES_FN_W
    '#endif // greater thean 2K
    '#if NTDDI_VERSION > NTDDI_WS03SP1
    ' Fields below this are available in OSes after W2k3SP1
    SetCredentialsAttributesW As LongPtr 'SET_CREDENTIALS_ATTRIBUTES_FN_W
    '#endif
    ChangeAccountPasswordW As LongPtr 'CHANGE_PASSInteger_FN_W
    '#else
    '    void *                      Reserved9;
    '#endif
    '#if NTDDI_VERSION > NTDDI_WINBLUE
    ' Fields below this are available in OSes after Windows 8.1
    QueryContextAttributesExW As LongPtr 'QUERY_CONTEXT_ATTRIBUTES_EX_FN_W
    QueryCredentialsAttributesExW As LongPtr 'QUERY_CREDENTIALS_ATTRIBUTES_EX_FN_W
    'endif
End Type

Public Enum SecuritySupportProviderIfaceVersions
    SECURITY_SUPPORT_PROVIDER_INTERFACE_VERSION = 1  ' ntifs
    '  Function table has all routines through SetContextAttributes
    SECURITY_SUPPORT_PROVIDER_INTERFACE_VERSION_2 = 2  ' ntifs
    '  Function table has all routines through SetCredentialsAttributes
    SECURITY_SUPPORT_PROVIDER_INTERFACE_VERSION_3 = 3  ' ntifs
    '  Function table has all routines through ChangeAccountPassword
    SECURITY_SUPPORT_PROVIDER_INTERFACE_VERSION_4 = 4  ' ntifs
    '  Function table has all routines through QueryCredentialsAttributesEx
    SECURITY_SUPPORT_PROVIDER_INTERFACE_VERSION_5 = 5  ' ntifs
End Enum


Public Declare PtrSafe Function InitSecurityInterfaceA Lib "secur32" () As LongPtr 'PSecurityFunctionTableA
Public Declare PtrSafe Function InitSecurityInterfaceW Lib "secur32" () As LongPtr 'PSecurityFunctionTableW
Public DeclareWide PtrSafe Function InitSecurityInterface Lib "secur32" Alias "InitSecurityInterfaceW" () As LongPtr 'PSecurityFunctionTable
Public Declare PtrSafe Function SaslEnumerateProfilesA Lib "secur32" (ProfileList As LongPtr, ProfileCount As Long) As Long
Public Declare PtrSafe Function SaslEnumerateProfilesW Lib "secur32" (ProfileList As LongPtr, ProfileCount As Long) As Long
Public DeclareWide PtrSafe Function SaslEnumerateProfiles Lib "secur32" Alias "SaslEnumerateProfilesW" (ProfileList As LongPtr, ProfileCount As Long) As Long
Public Declare PtrSafe Function SaslGetProfilePackageA Lib "secur32" (ByVal ProfileName As String, PackageInfo As LongPtr) As Long
Public Declare PtrSafe Function SaslGetProfilePackageW Lib "secur32" (ByVal ProfileName As LongPtr, PackageInfo As LongPtr) As Long
Public DeclareWide PtrSafe Function SaslGetProfilePackage Lib "secur32" Alias "SaslGetProfilePackageW" (ByVal ProfileName As String, PackageInfo As LongPtr) As Long
Public Declare PtrSafe Function SaslIdentifyPackageA Lib "secur32" (pInput As SecBufferDesc, PackageInfo As LongPtr) As Long
Public Declare PtrSafe Function SaslIdentifyPackageW Lib "secur32" (pInput As SecBufferDesc, PackageInfo As LongPtr) As Long
Public DeclareWide PtrSafe Function SaslIdentifyPackage Lib "secur32" Alias "SaslIdentifyPackageW" (pInput As SecBufferDesc, PackageInfo As LongPtr) As Long
Public Declare PtrSafe Function SaslInitializeSecurityContextA Lib "secur32" (phCredential As CredHandle, phContext As CtxtHandle, ByVal pszTargetName As String, ByVal fContextReq As SecurityInitContextReqFlags, ByVal Reserved1 As Long, ByVal TargetDataRep As SecurityDataRepConstants, pInput As SecBufferDesc, ByVal Reserved2 As Long, phNewContext As CtxtHandle, pOutput As SecBufferDesc, pfContextAttr As SecurityInitContextRetFlags, ptsExpiry As LongLong) As Long
Public Declare PtrSafe Function SaslInitializeSecurityContextW Lib "secur32" (phCredential As CredHandle, phContext As CtxtHandle, ByVal pszTargetName As LongPtr, ByVal fContextReq As SecurityInitContextReqFlags, ByVal Reserved1 As Long, ByVal TargetDataRep As SecurityDataRepConstants, pInput As SecBufferDesc, ByVal Reserved2 As Long, phNewContext As CtxtHandle, pOutput As SecBufferDesc, pfContextAttr As SecurityInitContextRetFlags, ptsExpiry As LongLong) As Long
Public DeclareWide PtrSafe Function SaslInitializeSecurityContext Lib "secur32" Alias "SaslInitializeSecurityContextW" (phCredential As CredHandle, phContext As CtxtHandle, ByVal pszTargetName As String, ByVal fContextReq As SecurityInitContextReqFlags, ByVal Reserved1 As Long, ByVal TargetDataRep As SecurityDataRepConstants, pInput As SecBufferDesc, ByVal Reserved2 As Long, phNewContext As CtxtHandle, pOutput As SecBufferDesc, pfContextAttr As SecurityInitContextRetFlags, ptsExpiry As LongLong) As Long
Public Declare PtrSafe Function SaslAcceptSecurityContext Lib "secur32" (phCredential As CredHandle, phContext As CtxtHandle, pInput As SecBufferDesc, ByVal fContextReq As SecurityAscReqFlags, ByVal TargetDataRep As SecurityDataRepConstants, phNewContext As CtxtHandle, pOutput As SecBufferDesc, pfContextAttr As SecurityAscRetFlags, ptsExpiry As LongLong) As Long

Public Enum SecurityaslContextOptions
    SASL_OPTION_SEND_SIZE = 1  ' Maximum size to send to peer
    SASL_OPTION_RECV_SIZE = 2  ' Maximum size willing to receive
    SASL_OPTION_AUTHZ_STRING = 3  ' Authorization string
    SASL_OPTION_AUTHZ_PROCESSING = 4  ' Authorization string processing
End Enum

Public Enum SASL_AUTHZID_STATE
    Sasl_AuthZIDForbidden = 0 ' allow no AuthZID strings to be specified - error out (default)
    Sasl_AuthZIDProcessed = 1 ' AuthZID Strings processed by Application or SSP
End Enum

Public Declare PtrSafe Function SaslSetContextOption Lib "secur32" (ContextHandle As CtxtHandle, ByVal Option As SecurityaslContextOptions, Value As Any, ByVal Size As Long) As Long
Public Declare PtrSafe Function SaslGetContextOption Lib "secur32" (ContextHandle As CtxtHandle, ByVal Option As SecurityaslContextOptions, Value As Any, ByVal Size As Long, Needed As Long) As Long

Public Enum AuthIdentityEx2Versions
    SEC_WINNT_AUTH_IDENTITY_VERSION_2 = &H201
End Enum
Public Type SEC_WINNT_AUTH_IDENTITY_EX2
    Version As AuthIdentityEx2Versions ' contains SEC_WINNT_AUTH_IDENTITY_VERSION_2
    cbHeaderLength As Integer
    cbStructureLength As Long
    UserOffset As Long ' Non-NULL terminated string, unicode only
    UserLength As Integer ' # of bytes (NOT WCHARs), not including NULL.
    DomainOffset As Long ' Non-NULL terminated string, unicode only
    DomainLength As Integer ' # of bytes (NOT WCHARs), not including NULL.
    PackedCredentialsOffset As Long ' Non-NULL terminated string, unicode only
    PackedCredentialsLength As Integer ' # of bytes (NOT WCHARs), not including NULL.
    Flags As SecAuthIdentityFlags
    PackageListOffset As Long ' Non-NULL terminated string, unicode only
    PackageListLength As Integer
End Type


Public Enum SecAuthIdentityFlags
    SEC_WINNT_AUTH_IDENTITY_ANSI = &H1
    SEC_WINNT_AUTH_IDENTITY_UNICODE = &H2
    SEC_WINNT_AUTH_IDENTITY_FLAGS_PROCESS_ENCRYPTED = &H10
'  the credential structure is protected by local system via
'  RtlEncryptMemory(OptionFlags=RTL_ENCRYPT_OPTION_SAME_LOGON)
    SEC_WINNT_AUTH_IDENTITY_FLAGS_SYSTEM_PROTECTED = &H20
'  the credential structure is encrypted by a non-system context
'  RtlEncryptMemory(OptionFlags=RTL_ENCRYPT_OPTION_SAME_LOGON)
    SEC_WINNT_AUTH_IDENTITY_FLAGS_USER_PROTECTED = &H40
'  the credential structure is encrypted with
'  RtlEncryptMemory(OptionFlags=RTL_ENCRYPT_OPTION_FOR_SYSTEM)
    SEC_WINNT_AUTH_IDENTITY_FLAGS_SYSTEM_ENCRYPTED = &H80
    SEC_WINNT_AUTH_IDENTITY_FLAGS_RESERVED = &H10000
    SEC_WINNT_AUTH_IDENTITY_FLAGS_NULL_USER = &H20000
    SEC_WINNT_AUTH_IDENTITY_FLAGS_NULL_DOMAIN = &H40000
    SEC_WINNT_AUTH_IDENTITY_FLAGS_ID_PROVIDER = &H80000
'   These bits are for communication between SspiPromptForCredentials()
'   and the credential providers. Do not use these bits for any other
'   purpose.
    SEC_WINNT_AUTH_IDENTITY_FLAGS_SSPIPFC_USE_MASK = &HFF000000
'   Instructs the credential provider to not save credentials itself
'   when caller selects the "Remember my credential" checkbox.
    SEC_WINNT_AUTH_IDENTITY_FLAGS_SSPIPFC_CREDPROV_DO_NOT_SAVE = &H80000000
'  Support the old name for this flag for callers that were built for earlier
'  versions of the SDK.
    SEC_WINNT_AUTH_IDENTITY_FLAGS_SSPIPFC_SAVE_CRED_BY_CALLER = SEC_WINNT_AUTH_IDENTITY_FLAGS_SSPIPFC_CREDPROV_DO_NOT_SAVE
'   State of the "Remember my credentials" checkbox.
'   When set, indicates checked; when cleared, indicates unchecked.
    SEC_WINNT_AUTH_IDENTITY_FLAGS_SSPIPFC_SAVE_CRED_CHECKED = &H40000000
'  The "Save" checkbox is not displayed on the credential provider tiles
    SEC_WINNT_AUTH_IDENTITY_FLAGS_SSPIPFC_NO_CHECKBOX = &H20000000
'  Credential providers will not attempt to prepopulate the CredUI dialog
'  box with credentials retrieved from Cred Man.
    SEC_WINNT_AUTH_IDENTITY_FLAGS_SSPIPFC_CREDPROV_DO_NOT_LOAD = &H10000000
    SEC_WINNT_AUTH_IDENTITY_FLAGS_VALID_SSPIPFC_FLAGS = (SEC_WINNT_AUTH_IDENTITY_FLAGS_SSPIPFC_CREDPROV_DO_NOT_SAVE Or SEC_WINNT_AUTH_IDENTITY_FLAGS_SSPIPFC_SAVE_CRED_CHECKED Or SEC_WINNT_AUTH_IDENTITY_FLAGS_SSPIPFC_NO_CHECKBOX Or SEC_WINNT_AUTH_IDENTITY_FLAGS_SSPIPFC_CREDPROV_DO_NOT_LOAD)
End Enum
Public Type SEC_WINNT_AUTH_IDENTITY_A
    User As String '  Non-NULL terminated string.
    UserLength As Long '  # of characters (NOT bytes), not including NULL.
    Domain As String '  Non-NULL terminated string.
    DomainLength As Long '  # of characters (NOT bytes), not including NULL.
    Password As String '  Non-NULL terminated string.
    PasswordLength As Long '  # of characters (NOT bytes), not including NULL.
    Flags As SecAuthIdentityFlags
End Type
Public Type SEC_WINNT_AUTH_IDENTITY_W
    User As LongPtr '  Non-NULL terminated string.
    UserLength As Long '  # of characters (NOT bytes), not including NULL.
    Domain As LongPtr '  Non-NULL terminated string.
    DomainLength As Long '  # of characters (NOT bytes), not including NULL.
    Password As LongPtr '  Non-NULL terminated string.
    PasswordLength As Long '  # of characters (NOT bytes), not including NULL.
    Flags As SecAuthIdentityFlags
End Type
Public Type SEC_WINNT_AUTH_IDENTITY
    User As LongPtr '  Non-NULL terminated string.
    UserLength As Long '  # of characters (NOT bytes), not including NULL.
    Domain As LongPtr '  Non-NULL terminated string.
    DomainLength As Long '  # of characters (NOT bytes), not including NULL.
    Password As LongPtr '  Non-NULL terminated string.
    PasswordLength As Long '  # of characters (NOT bytes), not including NULL.
    Flags As SecAuthIdentityFlags
End Type

Public Type SEC_WINNT_AUTH_IDENTITY_EXA
    Version As Long
    Length As Long
    User As String '  Non-NULL terminated string.
    UserLength As Long '  # of characters (NOT bytes), not including NULL.
    Domain As String '  Non-NULL terminated string.
    DomainLength As Long '  # of characters (NOT bytes), not including NULL.
    Password As String '  Non-NULL terminated string.
    PasswordLength As Long '  # of characters (NOT bytes), not including NULL.
    Flags As Long
    PackageList As LongPtr
    PackageListLength As Long
End Type
Public Type SEC_WINNT_AUTH_IDENTITY_EXW
    Version As Long
    Length As Long
    User As LongPtr '  Non-NULL terminated string.
    UserLength As Long '  # of characters (NOT bytes), not including NULL.
    Domain As LongPtr '  Non-NULL terminated string.
    DomainLength As Long '  # of characters (NOT bytes), not including NULL.
    Password As LongPtr '  Non-NULL terminated string.
    PasswordLength As Long '  # of characters (NOT bytes), not including NULL.
    Flags As Long
    PackageList As LongPtr
    PackageListLength As Long
End Type
Public Type SEC_WINNT_AUTH_IDENTITY_EX
    Version As Long
    Length As Long
    User As LongPtr '  Non-NULL terminated string.
    UserLength As Long '  # of characters (NOT bytes), not including NULL.
    Domain As LongPtr '  Non-NULL terminated string.
    DomainLength As Long '  # of characters (NOT bytes), not including NULL.
    Password As LongPtr '  Non-NULL terminated string.
    PasswordLength As Long '  # of characters (NOT bytes), not including NULL.
    Flags As Long
    PackageList As LongPtr
    PackageListLength As Long
End Type

Public Type /* Union */ SEC_WINNT_AUTH_IDENTITY_INFO
    ' typedef union _SEC_WINNT_AUTH_IDENTITY_INFO {
    ' SEC_WINNT_AUTH_IDENTITY_EXW AuthIdExw;
    ' SEC_WINNT_AUTH_IDENTITY_EXA AuthIdExa;
    ' SEC_WINNT_AUTH_IDENTITY_A AuthId_a;
    ' SEC_WINNT_AUTH_IDENTITY_W AuthId_w;
    ' SEC_WINNT_AUTH_IDENTITY_EX2 AuthIdEx2;
' } SEC_WINNT_AUTH_IDENTITY_INFO,
  #If Win64 Then
  AuthId(71) As Byte
  #Else
  AuthId(47) As Byte
  #End If
End Type

Public Enum SSPIPFC_Flags
    SSPIPFC_CREDPROV_DO_NOT_SAVE = &H00000001
'  Support the old name for this flag for callers that were built for earlier
'  versions of the SDK.
    SSPIPFC_SAVE_CRED_BY_CALLER = SSPIPFC_CREDPROV_DO_NOT_SAVE
'  The password and smart card credential providers will not display the
'  "Remember my credentials" check box in the provider tiles.
    SSPIPFC_NO_CHECKBOX = &H00000002
'  Credential providers will not attempt to prepopulate the CredUI dialog
'  box with credentials retrieved from Cred Man.
    SSPIPFC_CREDPROV_DO_NOT_LOAD = &H00000004
'  Credential providers along with UI Dialog will be hosted in a separate
'  broker process.
    SSPIPFC_USE_CREDUIBROKER = &H00000008
    SSPIPFC_VALID_FLAGS = (SSPIPFC_CREDPROV_DO_NOT_SAVE Or SSPIPFC_NO_CHECKBOX Or SSPIPFC_CREDPROV_DO_NOT_LOAD Or SSPIPFC_USE_CREDUIBROKER)
End Enum

Public Declare PtrSafe Function SspiPromptForCredentialsA Lib "credui" (ByVal pszTargetName As String, pUiInfo As CREDUI_INFOA, ByVal dwAuthError As Long, ByVal pszPackage As String, ByVal pInputAuthIdentity As LongPtr, ppAuthIdentity As LongPtr, pfSave As Long, ByVal dwFlags As SSPIPFC_Flags) As Long
Public Declare PtrSafe Function SspiPromptForCredentialsW Lib "credui" (ByVal pszTargetName As LongPtr, pUiInfo As CREDUI_INFOW, ByVal dwAuthError As Long, ByVal pszPackage As LongPtr, ByVal pInputAuthIdentity As LongPtr, ppAuthIdentity As LongPtr, pfSave As Long, ByVal dwFlags As SSPIPFC_Flags) As Long
Public DeclareWide PtrSafe Function SspiPromptForCredentials Lib "credui" Alias "SspiPromptForCredentialsW" (ByVal pszTargetName As String, pUiInfo As CREDUI_INFO, ByVal dwAuthError As Long, ByVal pszPackage As String, ByVal pInputAuthIdentity As LongPtr, ppAuthIdentity As LongPtr, pfSave As Long, ByVal dwFlags As SSPIPFC_Flags) As Long

Public Type SEC_WINNT_AUTH_BYTE_VECTOR
    ByteArrayOffset As Long ' each element is a byte
    ByteArrayLength As Integer '
End Type

Public Type SEC_WINNT_AUTH_DATA
    CredType As UUID
    CredData As SEC_WINNT_AUTH_BYTE_VECTOR
End Type
Public Type SEC_WINNT_AUTH_PACKED_CREDENTIALS
    cbHeaderLength As Integer ' the length of the header
    cbStructureLength As Integer ' pay load length including the header
    AuthData As SEC_WINNT_AUTH_DATA
End Type

Public Type SEC_WINNT_AUTH_DATA_PASSWORD
    UnicodePassword As SEC_WINNT_AUTH_BYTE_VECTOR
End Type
Public Type SEC_WINNT_AUTH_CERTIFICATE_DATA
    cbHeaderLength As Integer
    cbStructureLength As Integer
    Certificate As SEC_WINNT_AUTH_BYTE_VECTOR
End Type

Public Enum SecAuthNgcDataFlags
    NGC_DATA_FLAG_KERB_CERTIFICATE_LOGON_FLAG_CHECK_DUPLICATES = (&H1)  'corresponds to KERB_CERTIFICATE_LOGON_FLAG_CHECK_DUPLICATES
    NGC_DATA_FLAG_KERB_CERTIFICATE_LOGON_FLAG_USE_CERTIFICATE_INFO = (&H2)  'corresponds to  KERB_CERTIFICATE_LOGON_FLAG_USE_CERTIFICATE_INFO
    NGC_DATA_FLAG_IS_SMARTCARD_DATA = (&H4)
    NGC_DATA_FLAG_IS_CLOUD_TRUST_CRED = (&H8)  ' credential should be treated as "cloud trust" - use Cloud TGTs instead of on-prem PKINIT
End Enum
Public Type SEC_WINNT_AUTH_NGC_DATA
    LogonId As LUID
    Flags As SecAuthNgcDataFlags
    CspInfo As SEC_WINNT_AUTH_BYTE_VECTOR
    UserIdKeyAuthTicket As SEC_WINNT_AUTH_BYTE_VECTOR
    DecryptionKeyName As SEC_WINNT_AUTH_BYTE_VECTOR
    DecryptionKeyAuthTicket As SEC_WINNT_AUTH_BYTE_VECTOR
End Type

Public Type SEC_WINNT_AUTH_DATA_TYPE_SMARTCARD_CONTEXTS_DATA
    pcc As LongPtr
    hProv As LongPtr
    pwszECDHKeyName As LongPtr ' only optionally set for ECDSA smartcards
End Type

Public Type SEC_WINNT_AUTH_FIDO_DATA
    cbHeaderLength As Integer
    cbStructureLength As Integer
    Secret As SEC_WINNT_AUTH_BYTE_VECTOR ' offsets are from the beginning of this structure
    NewSecret As SEC_WINNT_AUTH_BYTE_VECTOR
    EncryptedNewSecret As SEC_WINNT_AUTH_BYTE_VECTOR ' For storage by cloud AP
    NetworkLogonBuffer As SEC_WINNT_AUTH_BYTE_VECTOR ' Opaque data, understood by plugin, may contain signed Nonce and other data to perform a network logon
    ulSignatureCount As LongLong ' signature count to be stored in public cached info, required for CredProv
End Type

Public Type SEC_WINNT_CREDUI_CONTEXT_VECTOR
    CredUIContextArrayOffset As Long ' offset starts at the beginning of
    ' this structure, and each element is a SEC_WINNT_AUTH_BYTE_VECTOR that
    ' describes the flat CredUI context returned by SpGetCredUIContext()
    CredUIContextCount As Integer
End Type

Public Type SEC_WINNT_AUTH_SHORT_VECTOR
    ShortArrayOffset As Long ' each element is a short
    ShortArrayCount As Integer ' number of characters
End Type

Public Declare PtrSafe Function SspiGetCredUIContext Lib "credui" (ByVal ContextHandle As LongPtr, CredType As UUID, LogonId As LUID, CredUIContexts As LongPtr, TokenHandle As LongPtr) As Long
Public Declare PtrSafe Function SspiUpdateCredentials Lib "credui" (ByVal ContextHandle As LongPtr, CredType As UUID, ByVal FlatCredUIContextLength As Long, FlatCredUIContext As Any) As Long

Public Type CREDUIWIN_MARSHALED_CONTEXT
    StructureType As UUID
    cbHeaderLength As Integer
    LogonId As LUID ' user's logon id
    MarshaledDataType As UUID
    MarshaledDataOffset As Long
    MarshaledDataLength As Integer
End Type

Public Type SEC_WINNT_CREDUI_CONTEXT
    cbHeaderLength As Integer
    CredUIContextHandle As LongPtr ' the handle to call SspiGetCredUIContext()
    UIInfo As LongPtr 'PCREDUI_INFOW ' input from SspiPromptForCredentials()
    dwAuthError As Long ' the authentication error
    pInputAuthIdentity As LongPtr 'PSEC_WINNT_AUTH_IDENTITY_OPAQUE
    TargetName As LongPtr 'PUNICODE_STRING
End Type

Public Type SEC_WINNT_AUTH_PACKED_CREDENTIALS_EX
    cbHeaderLength As Integer
    Flags As Long ' contains the Flags field in
    ' SEC_WINNT_AUTH_IDENTITY_EX
    PackedCredentials As SEC_WINNT_AUTH_BYTE_VECTOR
    PackageList As SEC_WINNT_AUTH_SHORT_VECTOR
End Type

Public Declare PtrSafe Function SspiUnmarshalCredUIContext Lib "credui" (ByVal MarshaledCredUIContext As LongPtr, ByVal MarshaledCredUIContextLength As Long, CredUIContext As LongPtr) As Long

Public Declare PtrSafe Function SspiPrepareForCredRead Lib "sspicli" (ByVal AuthIdentity As LongPtr, ByVal pszTargetName As LongPtr, pCredmanCredentialType As WinCredTypes, ppszCredmanTargetName As LongPtr) As Long
Public Declare PtrSafe Function SspiPrepareForCredWrite Lib "sspicli" (ByVal AuthIdentity As LongPtr, ByVal pszTargetName As LongPtr, pCredmanCredentialType As WinCredTypes, ppszCredmanTargetName As LongPtr, ppszCredmanUserName As LongPtr, ppCredentialBlob As LongPtr, pCredentialBlobSize As Long) As Long

Public Enum SecAuthIdentityCryptoFlags
    SEC_WINNT_AUTH_IDENTITY_ENCRYPT_SAME_LOGON = &H1
    SEC_WINNT_AUTH_IDENTITY_ENCRYPT_SAME_PROCESS = &H2
    SEC_WINNT_AUTH_IDENTITY_ENCRYPT_FOR_SYSTEM = &H4
End Enum

Public Declare PtrSafe Function SspiEncryptAuthIdentity Lib "sspicli" (ByVal AuthData As LongPtr) As Long
Public Declare PtrSafe Function SspiEncryptAuthIdentityEx Lib "sspicli" (ByVal Options As SecAuthIdentityCryptoFlags, ByVal AuthData As LongPtr) As Long
Public Declare PtrSafe Function SspiDecryptAuthIdentity Lib "sspicli" (ByVal EncryptedAuthData As LongPtr) As Long
Public Declare PtrSafe Function SspiDecryptAuthIdentityEx Lib "sspicli" (ByVal Options As SecAuthIdentityCryptoFlags, ByVal EncryptedAuthData As LongPtr) As Long
Public Declare PtrSafe Function SspiIsAuthIdentityEncrypted Lib "sspicli" (ByVal EncryptedAuthData As LongPtr) As Byte
Public Declare PtrSafe Function SspiEncodeAuthIdentityAsStrings Lib "sspicli" (ByVal AuthIdentity As LongPtr, ppszUserName As LongPtr, ppszDomainName As LongPtr, ppszPackedCredentialsString As LongPtr) As Long
Public Declare PtrSafe Function SspiValidateAuthIdentity Lib "sspicli" (ByVal AuthData As LongPtr) As Long
Public Declare PtrSafe Function SspiCopyAuthIdentity Lib "sspicli" (ByVal AuthData As LongPtr, AuthDataCopy As LongPtr) As Long
Public Declare PtrSafe Function SspiFreeAuthIdentity Lib "sspicli" (ByVal AuthData As LongPtr) As Long
Public Declare PtrSafe Function SspiZeroAuthIdentity Lib "sspicli" (ByVal AuthData As LongPtr) As Long
Public Declare PtrSafe Sub SspiLocalFree Lib "sspicli" (ByVal DataBuffer As LongPtr)
Public Declare PtrSafe Function SspiEncodeStringsAsAuthIdentity Lib "sspicli" (ByVal pszUserName As LongPtr, ByVal pszDomainName As LongPtr, ByVal pszPackedCredentialsString As LongPtr, ppAuthIdentity As LongPtr) As Long
Public Declare PtrSafe Function SspiCompareAuthIdentities Lib "sspicli" (ByVal AuthIdentity1 As LongPtr, ByVal AuthIdentity2 As LongPtr, SameSuppliedUser As Byte, SameSuppliedIdentity As Byte) As Long
Public Declare PtrSafe Function SspiMarshalAuthIdentity Lib "sspicli" (ByVal AuthIdentity As LongPtr, AuthIdentityLength As Long, AuthIdentityByteArray As LongPtr) As Long
Public Declare PtrSafe Function SspiUnmarshalAuthIdentity Lib "sspicli" (ByVal AuthIdentityLength As Long, AuthIdentityByteArray As Any, ppAuthIdentity As LongPtr) As Long

Public Declare PtrSafe Function SspiIsPromptingNeeded Lib "credui" (ByVal ErrorOrNtStatus As Long) As Byte

Public Declare PtrSafe Function SspiGetTargetHostName Lib "sspicli" (ByVal pszTargetName As LongPtr, pszHostName As LongPtr) As Long
Public Declare PtrSafe Function SspiExcludePackage Lib "sspicli" (ByVal AuthIdentity As LongPtr, ByVal pszPackageName As LongPtr, ppNewAuthIdentity As LongPtr) As Long

Public Enum SecSetChannelBindingFlags
    SEC_WINNT_AUTH_IDENTITY_MARSHALLED = &H4  ' all data is in one buffer
    SEC_WINNT_AUTH_IDENTITY_ONLY = &H8  ' these credentials are for identity only - no PAC needed
End Enum

Public Declare PtrSafe Function SspiSetChannelBindingFlags Lib "sspicli" (pBindings As SecPkgContext_Bindings, ByVal flags As SecSetChannelBindingFlags) As Long

Public Enum SecPackageOptionTypes
    SECPKG_OPTIONS_TYPE_UNKNOWN = 0
    SECPKG_OPTIONS_TYPE_LSA = 1
    SECPKG_OPTIONS_TYPE_SSPI = 2
End Enum
Public Enum SecPackageOptionFlags
    SECPKG_OPTIONS_PERMANENT = &H1
End Enum
Public Type SECURITY_PACKAGE_OPTIONS
    Size As Long
    Type As SecPackageOptionTypes
    Flags As SecPackageOptionFlags
    SignatureSize As Long
    Signature As LongPtr 'void*
End Type

Public Declare PtrSafe Function AddSecurityPackageA Lib "secur32" (ByVal pszPackageName As String, pOptions As SECURITY_PACKAGE_OPTIONS) As Long
Public Declare PtrSafe Function AddSecurityPackageW Lib "secur32" (ByVal pszPackageName As LongPtr, pOptions As SECURITY_PACKAGE_OPTIONS) As Long
Public DeclareWide PtrSafe Function AddSecurityPackage Lib "secur32" Alias "AddSecurityPackageW" (ByVal pszPackageName As String, pOptions As SECURITY_PACKAGE_OPTIONS) As Long
Public Declare PtrSafe Function DeleteSecurityPackageA Lib "secur32" (ByVal pszPackageName As String) As Long
Public Declare PtrSafe Function DeleteSecurityPackageW Lib "secur32" (ByVal pszPackageName As LongPtr) As Long
Public DeclareWide PtrSafe Function DeleteSecurityPackage Lib "secur32" Alias "DeleteSecurityPackageW" (ByVal pszPackageName As String) As Long


/*
minschannel.h
100% coverage
*/

Public Enum SecPkgExtendedAttributes
    SECPKG_ATTR_ISSUER_LIST = &H50  ' (OBSOLETE) returns SecPkgContext_IssuerListInfo
    SECPKG_ATTR_REMOTE_CRED = &H51  ' (OBSOLETE) returns SecPkgContext_RemoteCredentialInfo
    SECPKG_ATTR_LOCAL_CRED = &H52  ' (OBSOLETE) returns SecPkgContext_LocalCredentialInfo
    SECPKG_ATTR_REMOTE_CERT_CONTEXT = &H53  ' returns PCCERT_CONTEXT
    SECPKG_ATTR_LOCAL_CERT_CONTEXT = &H54  ' returns PCCERT_CONTEXT
    SECPKG_ATTR_ROOT_STORE = &H55  ' returns HCERTCONTEXT to the root store
    SECPKG_ATTR_SUPPORTED_ALGS = &H56  ' returns SecPkgCred_SupportedAlgs
    SECPKG_ATTR_CIPHER_STRENGTHS = &H57  ' returns SecPkgCred_CipherStrengths
    SECPKG_ATTR_SUPPORTED_PROTOCOLS = &H58  ' returns SecPkgCred_SupportedProtocols
    SECPKG_ATTR_ISSUER_LIST_EX = &H59  ' returns SecPkgContext_IssuerListInfoEx
    SECPKG_ATTR_CONNECTION_INFO = &H5a  ' returns SecPkgContext_ConnectionInfo
    SECPKG_ATTR_EAP_KEY_BLOCK = &H5b  ' returns SecPkgContext_EapKeyBlock
    SECPKG_ATTR_MAPPED_CRED_ATTR = &H5c  ' returns SecPkgContext_MappedCredAttr
    SECPKG_ATTR_SESSION_INFO = &H5d  ' returns SecPkgContext_SessionInfo
    SECPKG_ATTR_APP_DATA = &H5e  ' sets/returns SecPkgContext_SessionAppData
    SECPKG_ATTR_REMOTE_CERTIFICATES = &H5F  ' returns SecPkgContext_Certificates
    SECPKG_ATTR_CLIENT_CERT_POLICY = &H60  ' sets    SecPkgCred_ClientCertCtlPolicy
    SECPKG_ATTR_CC_POLICY_RESULT = &H61  ' returns SecPkgContext_ClientCertPolicyResult
    SECPKG_ATTR_USE_NCRYPT = &H62  ' Sets the CRED_FLAG_USE_NCRYPT_PROVIDER FLAG on cred group
    SECPKG_ATTR_LOCAL_CERT_INFO = &H63  ' returns SecPkgContext_CertInfo
    SECPKG_ATTR_CIPHER_INFO = &H64  ' returns new CNG SecPkgContext_CipherInfo
    SECPKG_ATTR_EAP_PRF_INFO = &H65  ' sets    SecPkgContext_EapPrfInfo
    SECPKG_ATTR_SUPPORTED_SIGNATURES = &H66  ' returns SecPkgContext_SupportedSignatures
    SECPKG_ATTR_REMOTE_CERT_CHAIN = &H67  ' returns PCCERT_CONTEXT
    SECPKG_ATTR_UI_INFO = &H68  ' sets SEcPkgContext_UiInfo
    SECPKG_ATTR_EARLY_START = &H69  ' sets SecPkgContext_EarlyStart
    SECPKG_ATTR_KEYING_MATERIAL_INFO = &H6a  ' sets SecPkgContext_KeyingMaterialInfo
    SECPKG_ATTR_KEYING_MATERIAL = &H6b  ' returns SecPkgContext_KeyingMaterial
    SECPKG_ATTR_SRTP_PARAMETERS = &H6c  ' returns negotiated SRTP parameters
    SECPKG_ATTR_TOKEN_BINDING = &H6d  ' returns SecPkgContext_TokenBinding
    SECPKG_ATTR_CONNECTION_INFO_EX = &H6e  ' returns SecPkgContext_ConnectionInfoEx
    SECPKG_ATTR_KEYING_MATERIAL_TOKEN_BINDING = &H6f  ' returns SecPkgContext_KeyingMaterial specific to Token Binding
    SECPKG_ATTR_KEYING_MATERIAL_INPROC = &H70  ' returns SecPkgContext_KeyingMaterial_Inproc
    SECPKG_ATTR_CERT_CHECK_RESULT = &H71  ' returns SecPkgContext_CertificateValidationResult, use during and after SSPI handshake loop
    SECPKG_ATTR_CERT_CHECK_RESULT_INPROC = &H72  ' returns SecPkgContext_CertificateValidationResult, use only after SSPI handshake loop
    SECPKG_ATTR_SESSION_TICKET_KEYS = &H73  ' sets    SecPkgCred_SessionTicketKeys
    SECPKG_ATTR_SERIALIZED_REMOTE_CERT_CONTEXT_INPROC = &H74  ' returns CERT_BLOB, use only after SSPI handshake loop
    SECPKG_ATTR_SERIALIZED_REMOTE_CERT_CONTEXT = &H75  ' returns CERT_BLOB, use during and after SSPI handshake loop
End Enum

Public Type SecPkgCred_SupportedAlgs
    cSupportedAlgs As Long
    palgSupportedAlgs As LongPtr '*ALG_ID
End Type

Public Type SecPkgCred_CipherStrengths
    dwMinimumCipherStrength As Long
    dwMaximumCipherStrength As Long
End Type

Public Type SecPkgCred_SupportedProtocols
    grbitProtocol As Long
End Type

Public Type SecPkgCred_ClientCertPolicy
    dwFlags As Long
    guidPolicyId As UUID
    dwCertFlags As CryptCertChainFlags
    dwUrlRetrievalTimeout As Long
    fCheckRevocationFreshnessTime As BOOL
    dwRevocationFreshnessTime As Long
    fOmitUsageCheck As BOOL
    pwszSslCtlStoreName As LongPtr
    pwszSslCtlIdentifier As LongPtr
End Type

Public Enum SessionTicketVersionDefs
    SESSION_TICKET_INFO_V0 = 0
    SESSION_TICKET_INFO_VERSION = SESSION_TICKET_INFO_V0
End Enum

Public Type SecPkgCred_SessionTicketKey
    TicketInfoVersion As Long ' Set to SESSION_TICKET_INFO_VERSION for the current session ticket protection method.
    KeyId(0 To 15) As Byte ' Uniquely identifies each session ticket key issued by a TLS server.
    KeyingMaterial(0 To 63) As Byte ' Must be generated using a cryptographic RNG.
    KeyingMaterialSize As Byte ' Size in bytes of the keying material in the KeyingMaterial array. Must be between 32 and 64.
End Type

Public Type SecPkgCred_SessionTicketKeys
    cSessionTicketKeys As Long ' Up to 16 keys.
    pSessionTicketKeys As LongPtr 'PSecPkgCred_SessionTicketKey
End Type

/*
schannel.h
100% coverage
*/

Public Const UNISP_NAME_A  = "Microsoft Unified Security Protocol Provider"
Public Const UNISP_NAME_W  = "Microsoft Unified Security Protocol Provider"
Public Const SSL2SP_NAME_A  = "Microsoft SSL 2.0"
Public Const SSL2SP_NAME_W  = "Microsoft SSL 2.0"
Public Const SSL3SP_NAME_A  = "Microsoft SSL 3.0"
Public Const SSL3SP_NAME_W  = "Microsoft SSL 3.0"
Public Const TLS1SP_NAME_A  = "Microsoft TLS 1.0"
Public Const TLS1SP_NAME_W  = "Microsoft TLS 1.0"
Public Const PCT1SP_NAME_A  = "Microsoft PCT 1.0"
Public Const PCT1SP_NAME_W  = "Microsoft PCT 1.0"
Public Const SCHANNEL_NAME_A  = "Schannel"
Public Const SCHANNEL_NAME_W  = "Schannel"
Public Const DEFAULT_TLS_SSP_NAME_A  = "Default TLS SSP"
Public Const DEFAULT_TLS_SSP_NAME_W  = "Default TLS SSP"
Public Const UNISP_NAME  = UNISP_NAME_W
Public Const PCT1SP_NAME  = PCT1SP_NAME_W
Public Const SSL2SP_NAME  = SSL2SP_NAME_W
Public Const SSL3SP_NAME  = SSL3SP_NAME_W
Public Const TLS1SP_NAME  = TLS1SP_NAME_W
Public Const SCHANNEL_NAME  = SCHANNEL_NAME_W
Public Const DEFAULT_TLS_SSP_NAME  = DEFAULT_TLS_SSP_NAME_W

Public Enum eTlsSignatureAlgorithm
    TlsSignatureAlgorithm_Anonymous = 0
    TlsSignatureAlgorithm_Rsa = 1
    TlsSignatureAlgorithm_Dsa = 2
    TlsSignatureAlgorithm_Ecdsa = 3
End Enum

Public Enum eTlsHashAlgorithm
    TlsHashAlgorithm_None = 0
    TlsHashAlgorithm_Md5 = 1
    TlsHashAlgorithm_Sha1 = 2
    TlsHashAlgorithm_Sha224 = 3
    TlsHashAlgorithm_Sha256 = 4
    TlsHashAlgorithm_Sha384 = 5
    TlsHashAlgorithm_Sha512 = 6
End Enum

Public Const UNISP_RPC_ID = 14

Public Type SecPkgContext_RemoteCredentialInfo
    cbCertificateChain As Long
    pbCertificateChain As LongPtr
    cCertificates As Long
    fFlags As SchannelRcredFlags
    dwBits As Long
End Type

Public Enum SchannelRcredFlags
    RCRED_STATUS_NOCRED = &H00000000
    RCRED_CRED_EXISTS = &H00000001
    RCRED_STATUS_UNKNOWN_ISSUER = &H00000002
End Enum

Public Type SecPkgContext_LocalCredentialInfo
    cbCertificateChain As Long
    pbCertificateChain As LongPtr
    cCertificates As Long
    fFlags As SchannelLcredFlags
    dwBits As Long
End Type

Public Enum SchannelLcredFlags
    LCRED_STATUS_NOCRED = &H00000000
    LCRED_CRED_EXISTS = &H00000001
    LCRED_STATUS_UNKNOWN_ISSUER = &H00000002
End Enum

Public Type SecPkgContext_ClientCertPolicyResult
    dwPolicyResult As Long
    guidPolicyId As UUID
End Type

Public Type SecPkgContext_IssuerListInfoEx
    aIssuers As LongPtr 'PCERT_NAME_BLOB
    cIssuers As Long
End Type

Public Type SecPkgContext_ConnectionInfo
    dwProtocol As SchannelProtocolFlags
    aiCipher As ALG_ID
    dwCipherStrength As Long
    aiHash As ALG_ID
    dwHashStrength As Long
    aiExch As ALG_ID
    dwExchStrength As Long
End Type

' Public Const SZ_ALG_MAX_SIZE  = 64
Public Const SECPKGCONTEXT_CONNECTION_INFO_EX_V1  = 1

Public Type SecPkgContext_ConnectionInfoEx
    dwVersion As Long
    dwProtocol As SchannelProtocolFlags
    szCipher(0 To (SZ_ALG_MAX_SIZE - 1)) As Integer
    dwCipherStrength As Long
    szHash(0 To (SZ_ALG_MAX_SIZE - 1)) As Integer
    dwHashStrength As Long
    szExchange(0 To (SZ_ALG_MAX_SIZE - 1)) As Integer
    dwExchStrength As Long
End Type

Public Const SECPKGCONTEXT_CIPHERINFO_V1  = 1

Public Type SecPkgContext_CipherInfo
    dwVersion As Long
    dwProtocol As SchannelProtocolFlags
    dwCipherSuite As Long
    dwBaseCipherSuite As Long
    szCipherSuite(0 To (SZ_ALG_MAX_SIZE - 1)) As Integer
    szCipher(0 To (SZ_ALG_MAX_SIZE - 1)) As Integer
    dwCipherLen As Long
    dwCipherBlockLen As Long ' in bytes
    szHash(0 To (SZ_ALG_MAX_SIZE - 1)) As Integer
    dwHashLen As Long
    szExchange(0 To (SZ_ALG_MAX_SIZE - 1)) As Integer
    dwMinExchangeLen As Long
    dwMaxExchangeLen As Long
    szCertificate(0 To (SZ_ALG_MAX_SIZE - 1)) As Integer
    dwKeyType As Long
End Type

Public Type SecPkgContext_EapKeyBlock
    rgbKeys(0 To 127) As Byte
    rgbIVs(0 To 63) As Byte
End Type

Public Type SecPkgContext_MappedCredAttr
    dwAttribute As Long
    pvBuffer As LongPtr
End Type

Public Enum SchannelSessionInfoFlags
    SSL_SESSION_RECONNECT = 1
End Enum

Public Type SecPkgContext_SessionInfo
    dwFlags As SchannelSessionInfoFlags
    cbSessionId As Long
    rgbSessionId(0 To 31) As Byte
End Type

Public Type SecPkgContext_SessionAppData
    dwFlags As Long
    cbAppData As Long
    pbAppData As LongPtr
End Type

Public Type SecPkgContext_EapPrfInfo
    dwVersion As Long
    cbPrfData As Long
    pbPrfData As LongPtr
End Type

Public Type SecPkgContext_SupportedSignatures
    cSignatureAndHashAlgorithms As Integer
    ' Upper byte (from TLS 1.2, RFC 4346):
    '     enum {
    '         anonymous(0), rsa(1), dsa(2), ecdsa(3), (255)
    '     } SignatureAlgorithm;
    ' enum eTlsSignatureAlgorithm
    ' Lower byte (from TLS 1.2, RFC 4346):
    '     enum {
    '         none(0), md5(1), sha1(2), sha224(3), sha256(4), sha384(5),
    '         sha512(6), (255)
    '     } HashAlgorithm;
    ' enum eTlsHashAlgorithm
    ' _Field_size_(cSignatureAndHashAlgorithms)
    pSignatureAndHashAlgorithms As LongPtr 'WORD*
End Type

Public Type SecPkgContext_Certificates
    cCertificates As Long
    cbCertificateChain As Long
    pbCertificateChain As LongPtr
End Type
Public Type SecPkgContext_CertInfo
    dwVersion As Long
    cbSubjectName As Long
    pwszSubjectName As LongPtr
    cbIssuerName As Long
    pwszIssuerName As LongPtr
    dwKeySize As Long
End Type
Public Const KERN_CONTEXT_CERT_INFO_V1  = &H00000000

Public Type SecPkgContext_UiInfo
    hParentWindow As LongPtr
End Type

Public Type SecPkgContext_EarlyStart
    dwEarlyStartFlags As SchannelEarlyStartFlags
End Type

Public Enum SchannelEarlyStartFlags
    ENABLE_TLS_CLIENT_EARLY_START = &H00000001
End Enum

Public Type SecPkgContext_KeyingMaterialInfo
    cbLabel As Integer ' Disambiguating ASCII label length, in bytes, greater than 0.
    pszLabel As LongPtr ' Disambiguating ASCII label, NUL terminator will be removed by schannel.
    cbContextValue As Integer ' Application context value length, in bytes, can be 0.
    pbContextValue As LongPtr ' Application context value, NULL if cbContextValue == 0.
    cbKeyingMaterial As Long ' Requested keying material length, in bytes, greater than 0.
End Type

Public Type SecPkgContext_KeyingMaterial
    cbKeyingMaterial As Long ' Exported keying material length, in bytes.
    pbKeyingMaterial As LongPtr ' Exported keying material.
End Type

Public Type SecPkgContext_KeyingMaterial_Inproc
    cbLabel As Integer ' Disambiguating ASCII label length, in bytes, greater than 0.
    pszLabel As String ' Disambiguating ASCII label, NUL terminator will be removed by schannel.
    cbContextValue As Integer ' Application context value length, in bytes, can be 0.
    pbContextValue As LongPtr ' Application context value, NULL if cbContextValue == 0.
    cbKeyingMaterial As Long ' Requested keying material length, in bytes, greater than 0.
    pbKeyingMaterial As LongPtr ' Exported keying material.
End Type

Public Type SecPkgContext_SrtpParameters
    ProtectionProfile As Integer ' Negotiated SRTP protection profile (0x0000 means no profile negotiated).
    MasterKeyIdentifierSize As Byte ' Size in bytes of the SRTP master key identifier.
    MasterKeyIdentifier As LongPtr ' Negotiated SRTP master key identifier.
End Type

Public Type SecPkgContext_TokenBinding
    MajorVersion As Byte ' Negotiated major version of the Token Binding protocol.
    MinorVersion As Byte ' Negotiated minor version of the Token Binding protocol.
    KeyParametersSize As Integer ' Size in bytes of the KeyParameters array.
    KeyParameters As LongPtr ' IDs of the negotiated Token Binding key parameters.
End Type

Public Type SecPkgContext_CertificateValidationResult
    dwChainErrorStatus As Long ' Contains chain build error flags set by CertGetCertificateChain.
    hrVerifyChainStatus As Long ' Certificate validation policy error returned by CertVerifyCertificateChainPolicy.
End Type

Public Enum SchannelCredVersion
    SCH_CRED_V1 = &H00000001
    SCH_CRED_V2 = &H00000002  ' for legacy code
    SCH_CRED_VERSION = &H00000002  ' for legacy code
    SCH_CRED_V3 = &H00000003  ' for legacy code
    SCHANNEL_CRED_VERSION = &H00000004  ' for legacy code
    SCH_CREDENTIALS_VERSION = &H00000005
End Enum

Public Type SCHANNEL_CRED
    dwVersion As SchannelCredVersion ' always SCHANNEL_CRED_VERSION
    cCreds As Long
    paCred As LongPtr 'PCCERT_CONTEXT
    hRootStore As LongPtr 'HCERTSTORE
    cMappers As Long
    aphMappers As LongPtr 'struct _HMAPPER**
    cSupportedAlgs As Long
    palgSupportedAlgs As LongPtr 'ALG_ID*
    grbitEnabledProtocols As SchannelProtocolFlags
    dwMinimumCipherStrength As Long
    dwMaximumCipherStrength As Long
    dwSessionLifespan As Long
    dwFlags As SchannelCredFlags
    dwCredFormat As SchannelCredFmtFlags
End Type

Public Const SCHANNEL_RSA_PSS_PADDING_ALGORITHM  = "SCH_RSA_PSS_PAD"
Public Const SCHANNEL_RSA_PKCS_PADDING_ALGORITHM  = "SCH_RSA_PKCS_PAD"

Public Enum eTlsAlgorithmUsage
    TlsParametersCngAlgUsageKeyExchange   ' Key exchange algorithm. RSA, ECHDE, DHE, etc.
    TlsParametersCngAlgUsageSignature   ' Signature algorithm. RSA, DSA, ECDSA, etc.
    TlsParametersCngAlgUsageCipher   ' Encryption algorithm. AES, DES, RC4, etc.
    TlsParametersCngAlgUsageDigest   ' Digest of cipher suite. SHA1, SHA256, SHA384, etc.
    TlsParametersCngAlgUsageCertSig   ' Signature, hash and/or padding mode components of a TLS signature suite. RSA, DSA, ECDSA, SHA1, SHA256, PSS, etc.
End Enum

Public Type CRYPTO_SETTINGS
    eAlgorithmUsage As eTlsAlgorithmUsage ' How this algorithm is being used.
    strCngAlgId As UNICODE_STRING ' CNG algorithm identifier.
    cChainingModes As Long ' Set to 0 if CNG algorithm does not have a chaining mode.
    rgstrChainingModes As LongPtr 'PUNICODE_STRING ' Set to NULL if CNG algorithm does not have a chaining mode.
    dwMinBitLength As Long ' Blacklist key sizes less than this. Set to 0 if not defined or CNG algorithm implies bit length.
    dwMaxBitLength As Long ' Blacklist key sizes greater than this. Set to 0 if not defined or CNG algorithm implies bit length.
End Type

Public Type TLS_PARAMETERS
    cAlpnIds As Long ' Valid for server applications only. Must be zero otherwise. Number of ALPN IDs in rgstrAlpnIds; set to 0 if applies to all.
    rgstrAlpnIds As LongPtr 'PUNICODE_STRING ' Valid for server applications only. Must be NULL otherwise. Array of ALPN IDs that the following settings apply to; set to NULL if applies to all.
    grbitDisabledProtocols As Long ' List protocols you DO NOT want negotiated.
    cDisabledCrypto As Long ' Number of CRYPTO_SETTINGS structures; set to 0 if there are none.
    pDisabledCrypto As LongPtr 'PCRYPTO_SETTINGS ' Array of CRYPTO_SETTINGS structures; set to NULL if there are none;
    dwFlags As SchannelTlsParamFlags ' Optional flags to pass; set to 0 if there are none.
End Type

Public Enum SchannelTlsParamFlags
    TLS_PARAMS_OPTIONAL = &H00000001           ' Valid for server applications only. Must be zero otherwise.
                                               ' TLS_PARAMETERS that will only be honored if they do not cause this server to terminate the handshake.
End Enum

Public Type SCH_CREDENTIALS
    dwVersion As SchannelCredVersion ' Always SCH_CREDENTIALS_VERSION.
    dwCredFormat As SchannelCredFmtFlags
    cCreds As Long
    paCred As LongPtr 'PCCERT_CONTEXT
    hRootStore As LongPtr 'HCERTSTORE
    cMappers As Long
    aphMappers As LongPtr '_HMAPPER**
    dwSessionLifespan As Long
    dwFlags As SchannelCredFlags
    cTlsParameters As Long
    pTlsParameters As LongPtr 'PTLS_PARAMETERS
End Type

Public Const SCH_CRED_MAX_SUPPORTED_PARAMETERS  = 16
Public Const SCH_CRED_MAX_SUPPORTED_ALPN_IDS  = 16
Public Const SCH_CRED_MAX_SUPPORTED_CRYPTO_SETTINGS  = 16
Public Const SCH_CRED_MAX_SUPPORTED_CHAINING_MODES  = 16

[Description("WARNING: Buffer substituted for variable C-style array.")]
Public Type SEND_GENERIC_TLS_EXTENSION
    ExtensionType As Integer ' Code point of extension.
    HandshakeType As Integer ' Message type used to transport extension.
    Flags As Long ' Flags used to modify behavior. Must be zero.
    BufferSize As Integer ' Size in bytes of the extension data.
    Buffer(4095) As Byte ' Extension data.
End Type

Public Type TLS_EXTENSION_SUBSCRIPTION
    ExtensionType As Integer ' Code point of extension.
    HandshakeType As Integer ' Message type used to transport extension.
End Type

[Description("WARNING: Buffer substituted for variable C-style array.")]
Public Type SUBSCRIBE_GENERIC_TLS_EXTENSION
    Flags As Long ' Flags used to modify behavior. Must be zero.
    SubscriptionsCount As Long ' Number of elements in the Subscriptions array.
    Subscriptions(255) As TLS_EXTENSION_SUBSCRIPTION ' Array of TLS_EXTENSION_SUBSCRIPTION structures.
End Type

Public Const SCH_MAX_EXT_SUBSCRIPTIONS  = 2

Public Enum SchannelCredFmtFlags
    SCH_CRED_FORMAT_CERT_CONTEXT = &H00000000
    SCH_CRED_FORMAT_CERT_HASH = &H00000001
    SCH_CRED_FORMAT_CERT_HASH_STORE = &H00000002
End Enum

Public Const SCH_CRED_MAX_STORE_NAME_SIZE  = 128
Public Const SCH_CRED_MAX_SUPPORTED_ALGS  = 256
Public Const SCH_CRED_MAX_SUPPORTED_CERTS  = 100

Public Type SCHANNEL_CERT_HASH
    dwLength As Long
    dwFlags As SchannelCertHashFlags
    hProv As LongPtr 'HCRYPTPROV
    ShaHash(0 To 19) As Byte
End Type

Public Enum SchannelCertHashFlags
    SCH_MACHINE_CERT_HASH = &H00000001
End Enum

Public Enum SchannelCredFlags
    SCH_CRED_NO_SYSTEM_MAPPER = &H00000002
    SCH_CRED_NO_SERVERNAME_CHECK = &H00000004
    SCH_CRED_MANUAL_CRED_VALIDATION = &H00000008
    SCH_CRED_NO_DEFAULT_CREDS = &H00000010
    SCH_CRED_AUTO_CRED_VALIDATION = &H00000020
    SCH_CRED_USE_DEFAULT_CREDS = &H00000040
    SCH_CRED_DISABLE_RECONNECTS = &H00000080
    SCH_CRED_REVOCATION_CHECK_END_CERT = &H00000100
    SCH_CRED_REVOCATION_CHECK_CHAIN = &H00000200
    SCH_CRED_REVOCATION_CHECK_CHAIN_EXCLUDE_ROOT = &H00000400
    SCH_CRED_IGNORE_NO_REVOCATION_CHECK = &H00000800
    SCH_CRED_IGNORE_REVOCATION_OFFLINE = &H00001000
    SCH_CRED_RESTRICTED_ROOTS = &H00002000
    SCH_CRED_REVOCATION_CHECK_CACHE_ONLY = &H00004000
    SCH_CRED_CACHE_ONLY_URL_RETRIEVAL = &H00008000&
    SCH_CRED_MEMORY_STORE_CERT = &H00010000
    SCH_CRED_CACHE_ONLY_URL_RETRIEVAL_ON_CREATE = &H00020000
    SCH_SEND_ROOT_CERT = &H00040000
    SCH_CRED_SNI_CREDENTIAL = &H00080000
    SCH_CRED_SNI_ENABLE_OCSP = &H00100000
    SCH_SEND_AUX_RECORD = &H00200000
    SCH_USE_STRONG_CRYPTO = &H00400000
    SCH_USE_PRESHAREDKEY_ONLY = &H00800000
    SCH_USE_DTLS_ONLY = &H01000000
    SCH_ALLOW_NULL_ENCRYPTION = &H02000000
    SCH_CRED_DEFERRED_CRED_VALIDATION = &H04000000
End Enum

Public Enum SchannelControlTokenTypes
    SCHANNEL_RENEGOTIATE = 0  ' renegotiate a connection
    SCHANNEL_SHUTDOWN = 1  ' gracefully close down a connection
    SCHANNEL_ALERT = 2  ' build an error message
    SCHANNEL_SESSION = 3  ' session control
End Enum

Public Type SCHANNEL_ALERT_TOKEN
    dwTokenType As SchannelControlTokenTypes ' SCHANNEL_ALERT
    dwAlertType As SchannelAlertTypes
    dwAlertNumber As SchannelAlertMessages
End Type

Public Enum SchannelAlertTypes
    TLS1_ALERT_WARNING = 1
    TLS1_ALERT_FATAL = 2
End Enum

Public Enum SchannelAlertMessages
    TLS1_ALERT_CLOSE_NOTIFY = 0  ' warning
    TLS1_ALERT_UNEXPECTED_MESSAGE = 10  ' error
    TLS1_ALERT_BAD_RECORD_MAC = 20  ' error
    TLS1_ALERT_DECRYPTION_FAILED = 21  ' reserved
    TLS1_ALERT_RECORD_OVERFLOW = 22  ' error
    TLS1_ALERT_DECOMPRESSION_FAIL = 30  ' error
    TLS1_ALERT_HANDSHAKE_FAILURE = 40  ' error
    TLS1_ALERT_BAD_CERTIFICATE = 42  ' warning or error
    TLS1_ALERT_UNSUPPORTED_CERT = 43  ' warning or error
    TLS1_ALERT_CERTIFICATE_REVOKED = 44  ' warning or error
    TLS1_ALERT_CERTIFICATE_EXPIRED = 45  ' warning or error
    TLS1_ALERT_CERTIFICATE_UNKNOWN = 46  ' warning or error
    TLS1_ALERT_ILLEGAL_PARAMETER = 47  ' error
    TLS1_ALERT_UNKNOWN_CA = 48  ' error
    TLS1_ALERT_ACCESS_DENIED = 49  ' error
    TLS1_ALERT_DECODE_ERROR = 50  ' error
    TLS1_ALERT_DECRYPT_ERROR = 51  ' error
    TLS1_ALERT_EXPORT_RESTRICTION = 60  ' reserved
    TLS1_ALERT_PROTOCOL_VERSION = 70  ' error
    TLS1_ALERT_INSUFFIENT_SECURITY = 71  ' error
    TLS1_ALERT_INTERNAL_ERROR = 80  ' error
    TLS1_ALERT_USER_CANCELED = 90  ' warning or error
    TLS1_ALERT_NO_RENEGOTIATION = 100  ' warning
    TLS1_ALERT_UNSUPPORTED_EXT = 110  ' error
    TLS1_ALERT_UNKNOWN_PSK_IDENTITY = 115  ' error
    TLS1_ALERT_NO_APP_PROTOCOL = 120  ' error
End Enum

Public Enum SchannelSessionControlFlags
    SSL_SESSION_ENABLE_RECONNECTS = 1
    SSL_SESSION_DISABLE_RECONNECTS = 2
End Enum

Public Type SCHANNEL_SESSION_TOKEN
    dwTokenType As SchannelControlTokenTypes ' SCHANNEL_SESSION
    dwFlags As SchannelSessionControlFlags
End Type

Public Type SCHANNEL_CLIENT_SIGNATURE
    cbLength As Long
    aiHash As ALG_ID
    cbHash As Long
    HashValue(0 To 35) As Byte
    CertThumbprint(0 To 19) As Byte
End Type

Public Enum SchannelProtocolFlags
    SP_PROT_PCT1_SERVER = &H00000001
    SP_PROT_PCT1_CLIENT = &H00000002
    SP_PROT_PCT1 = (SP_PROT_PCT1_SERVER Or SP_PROT_PCT1_CLIENT)
    SP_PROT_SSL2_SERVER = &H00000004
    SP_PROT_SSL2_CLIENT = &H00000008
    SP_PROT_SSL2 = (SP_PROT_SSL2_SERVER Or SP_PROT_SSL2_CLIENT)
    SP_PROT_SSL3_SERVER = &H00000010
    SP_PROT_SSL3_CLIENT = &H00000020
    SP_PROT_SSL3 = (SP_PROT_SSL3_SERVER Or SP_PROT_SSL3_CLIENT)
    SP_PROT_TLS1_SERVER = &H00000040
    SP_PROT_TLS1_CLIENT = &H00000080
    SP_PROT_TLS1 = (SP_PROT_TLS1_SERVER Or SP_PROT_TLS1_CLIENT)
    SP_PROT_SSL3TLS1_CLIENTS = (SP_PROT_TLS1_CLIENT Or SP_PROT_SSL3_CLIENT)
    SP_PROT_SSL3TLS1_SERVERS = (SP_PROT_TLS1_SERVER Or SP_PROT_SSL3_SERVER)
    SP_PROT_SSL3TLS1 = (SP_PROT_SSL3 Or SP_PROT_TLS1)
    SP_PROT_UNI_SERVER = &H40000000
    SP_PROT_UNI_CLIENT = &H80000000
    SP_PROT_UNI = (SP_PROT_UNI_SERVER Or SP_PROT_UNI_CLIENT)
    SP_PROT_ALL = &Hffffffff
    SP_PROT_NONE = 0
    SP_PROT_CLIENTS = (SP_PROT_PCT1_CLIENT Or SP_PROT_SSL2_CLIENT Or SP_PROT_SSL3_CLIENT Or SP_PROT_UNI_CLIENT Or SP_PROT_TLS1_CLIENT)
    SP_PROT_SERVERS = (SP_PROT_PCT1_SERVER Or SP_PROT_SSL2_SERVER Or SP_PROT_SSL3_SERVER Or SP_PROT_UNI_SERVER Or SP_PROT_TLS1_SERVER)
    SP_PROT_TLS1_0_SERVER = SP_PROT_TLS1_SERVER
    SP_PROT_TLS1_0_CLIENT = SP_PROT_TLS1_CLIENT
    SP_PROT_TLS1_0 = (SP_PROT_TLS1_0_SERVER Or SP_PROT_TLS1_0_CLIENT)
    SP_PROT_TLS1_1_SERVER = &H00000100
    SP_PROT_TLS1_1_CLIENT = &H00000200
    SP_PROT_TLS1_1 = (SP_PROT_TLS1_1_SERVER Or SP_PROT_TLS1_1_CLIENT)
    SP_PROT_TLS1_2_SERVER = &H00000400
    SP_PROT_TLS1_2_CLIENT = &H00000800
    SP_PROT_TLS1_2 = (SP_PROT_TLS1_2_SERVER Or SP_PROT_TLS1_2_CLIENT)
    SP_PROT_TLS1_3_SERVER = &H00001000
    SP_PROT_TLS1_3_CLIENT = &H00002000
    SP_PROT_TLS1_3 = (SP_PROT_TLS1_3_SERVER Or SP_PROT_TLS1_3_CLIENT)
    SP_PROT_DTLS_SERVER = &H00010000
    SP_PROT_DTLS_CLIENT = &H00020000
    SP_PROT_DTLS = (SP_PROT_DTLS_SERVER Or SP_PROT_DTLS_CLIENT)
    SP_PROT_DTLS1_0_SERVER = SP_PROT_DTLS_SERVER
    SP_PROT_DTLS1_0_CLIENT = SP_PROT_DTLS_CLIENT
    SP_PROT_DTLS1_0 = (SP_PROT_DTLS1_0_SERVER Or SP_PROT_DTLS1_0_CLIENT)
    SP_PROT_DTLS1_2_SERVER = &H00040000
    SP_PROT_DTLS1_2_CLIENT = &H00080000
    SP_PROT_DTLS1_2 = (SP_PROT_DTLS1_2_SERVER Or SP_PROT_DTLS1_2_CLIENT)
    SP_PROT_DTLS1_X_SERVER = (SP_PROT_DTLS1_0_SERVER Or SP_PROT_DTLS1_2_SERVER)
    SP_PROT_DTLS1_X_CLIENT = (SP_PROT_DTLS1_0_CLIENT Or SP_PROT_DTLS1_2_CLIENT)
    SP_PROT_DTLS1_X = (SP_PROT_DTLS1_X_SERVER Or SP_PROT_DTLS1_X_CLIENT)
    SP_PROT_TLS1_1PLUS_SERVER = (SP_PROT_TLS1_1_SERVER Or SP_PROT_TLS1_2_SERVER Or SP_PROT_TLS1_3_SERVER)
    SP_PROT_TLS1_1PLUS_CLIENT = (SP_PROT_TLS1_1_CLIENT Or SP_PROT_TLS1_2_CLIENT Or SP_PROT_TLS1_3_CLIENT)
    SP_PROT_TLS1_1PLUS = (SP_PROT_TLS1_1PLUS_SERVER Or SP_PROT_TLS1_1PLUS_CLIENT)
    SP_PROT_TLS1_3PLUS_SERVER = SP_PROT_TLS1_3_SERVER
    SP_PROT_TLS1_3PLUS_CLIENT = SP_PROT_TLS1_3_CLIENT
    SP_PROT_TLS1_3PLUS = (SP_PROT_TLS1_3PLUS_SERVER Or SP_PROT_TLS1_3PLUS_CLIENT)
    SP_PROT_TLS1_X_SERVER = (SP_PROT_TLS1_0_SERVER Or SP_PROT_TLS1_1_SERVER Or SP_PROT_TLS1_2_SERVER Or SP_PROT_TLS1_3_SERVER)
    SP_PROT_TLS1_X_CLIENT = (SP_PROT_TLS1_0_CLIENT Or SP_PROT_TLS1_1_CLIENT Or SP_PROT_TLS1_2_CLIENT Or SP_PROT_TLS1_3_CLIENT)
    SP_PROT_TLS1_X = (SP_PROT_TLS1_X_SERVER Or SP_PROT_TLS1_X_CLIENT)
    SP_PROT_SSL3TLS1_X_CLIENTS = (SP_PROT_TLS1_X_CLIENT Or SP_PROT_SSL3_CLIENT)
    SP_PROT_SSL3TLS1_X_SERVERS = (SP_PROT_TLS1_X_SERVER Or SP_PROT_SSL3_SERVER)
    SP_PROT_SSL3TLS1_X = (SP_PROT_SSL3 Or SP_PROT_TLS1_X)
    SP_PROT_X_CLIENTS = (SP_PROT_CLIENTS Or SP_PROT_TLS1_X_CLIENT Or SP_PROT_DTLS1_X_CLIENT)
    SP_PROT_X_SERVERS = (SP_PROT_SERVERS Or SP_PROT_TLS1_X_SERVER Or SP_PROT_DTLS1_X_SERVER)
End Enum

Public Delegate Function SSL_EMPTY_CACHE_FN_A (ByVal pszTargetName As LongPtr, ByVal dwFlags As Long) As BOOL
Public Delegate Function SSL_EMPTY_CACHE_FN_W (ByVal pszTargetName As LongPtr, ByVal dwFlags As Long) As BOOL
Public Delegate Function SSL_EMPTY_CACHE_FN (ByVal pszTargetName As LongPtr, ByVal dwFlags As Long) As BOOL
' ]alias

Public Declare PtrSafe Function SslEmptyCacheA Lib "schannel.dll" (ByVal pszTargetName As String, ByVal dwFlags As Long) As BOOL
Public Declare PtrSafe Function SslEmptyCacheW Lib "schannel.dll" (ByVal pszTargetName As LongPtr, ByVal dwFlags As Long) As BOOL
Public DeclareWide PtrSafe Function SslEmptyCache Lib "schannel.dll" Alias "SslEmptyCacheW" (ByVal pszTargetName As String, ByVal dwFlags As Long) As BOOL

Public Type SSL_CREDENTIAL_CERTIFICATE
    cbPrivateKey As Long
    pPrivateKey As LongPtr
    cbCertificate As Long
    pCertificate As LongPtr
    pszPassword As LongPtr 'PSTR
End Type

Public Enum SchannelSecretlFlags
    SCHANNEL_SECRET_TYPE_CAPI = &H00000001
    SCHANNEL_SECRET_PRIVKEY = &H00000002
End Enum
Public Enum SchannelCredCertFlags
    SCH_CRED_X509_CERTCHAIN = &H00000001
    SCH_CRED_X509_CAPI = &H00000002
    SCH_CRED_CERT_CONTEXT = &H00000003
End Enum

Public Type SCH_CRED
    dwVersion As SchannelCredVersion ' always SCH_CRED_VERSION.
    cCreds As Long ' Number of credentials.
    paSecret As LongPtr ' Array of SCH_CRED_SECRET_* pointers
    paPublic As LongPtr ' Array of SCH_CRED_PUBLIC_* pointers
    cMappers As Long ' Number of credential mappers.
    aphMappers As LongPtr 'HMAPPER** ' pointer to an array of pointers to credential mappers
End Type

Public Type SCH_CRED_SECRET_CAPI
    dwType As SchannelSecretlFlags ' SCHANNEL_SECRET_TYPE_CAPI
    hProv As LongPtr 'HCRYPTPROV ' credential secret information.
End Type

Public Type SCH_CRED_SECRET_PRIVKEY
    dwType As SchannelSecretlFlags ' SCHANNEL_SECRET_PRIVKEY
    pPrivateKey As LongPtr ' Der encoded private key
    cbPrivateKey As Long
    pszPassword As LongPtr 'PSTR ' Password to crack the private key.
End Type

Public Type SCH_CRED_PUBLIC_CERTCHAIN
    dwType As SchannelCredCertFlags
    cbCertChain As Long
    pCertChain As LongPtr
End Type

[Description("WARNING: Buffer substituted for variable C-style array.")]
Public Type PctPublicKey
    Type As Long
    cbKey As Long
    pKey(0 To 4095) As Byte
End Type

Public Type X509Certificate
    Version As Long
    SerialNumber(0 To 3) As Long
    SignatureAlgorithm As ALG_ID
    ValidFrom As FILETIME
    ValidUntil As FILETIME
    pszIssuer As LongPtr 'PSTR
    pszSubject As LongPtr 'PSTR
    pPublicKey As LongPtr 'PctPublicKey *
End Type

Public Declare PtrSafe Function SslGenerateKeyPair Lib "schannel.dll" (pCerts As SSL_CREDENTIAL_CERTIFICATE, ByVal pszDN As String, ByVal pszPassword As String) As BOOL
Public Declare PtrSafe Sub SslGenerateRandomBits Lib "schannel.dll" (pRandomData As Any, ByVal cRandomData As Long)
Public Declare PtrSafe Function SslCrackCertificate Lib "schannel.dll" (pbCertificate As Any, ByVal cbCertificate As Long, ByVal dwFlags As SchannelCrackCertFlags, ppCertificate As LongPtr) As BOOL
Public Declare PtrSafe Sub SslFreeCertificate Lib "schannel.dll" (ByVal pCertificate As LongPtr)
Public Declare PtrSafe Function SslGetMaximumKeySize Lib "schannel.dll" (ByVal Reserved As Long) As Long
Public Declare PtrSafe Function SslGetDefaultIssuers Lib "schannel.dll" (pbIssuers As Any, pcbIsusers As Long) As Long

Public Const SSL_CRACK_CERTIFICATE_NAME  = "SslCrackCertificate"
Public Const SSL_FREE_CERTIFICATE_NAME  = "SslFreeCertificate"

Public Delegate Function SSL_CRACK_CERTIFICATE_FN (pbCertificate As Any, ByVal cbCertificate As Long, ByVal dwFlags As SchannelCrackCertFlags, ppCertificate As LongPtr) As BOOL
Public Delegate Sub SSL_FREE_CERTIFICATE_FN (ByVal pCertificate As LongPtr)

Public Delegate Function SslGetServerIdentityFn (ClientHello As Any, ByVal ClientHelloSize As Long, ServerIdentity As LongPtr, ServerIdentitySize As Long, ByVal Flags As Long) As SECURITY_STATUS

Public Declare PtrSafe Function SslGetServerIdentity Lib "schannel.dll" (ClientHello As Any, ByVal ClientHelloSize As Long, ServerIdentity As LongPtr, ServerIdentitySize As Long, ByVal Flags As Long) As SECURITY_STATUS

Public Type SCH_EXTENSION_DATA
    ExtensionType As Integer
    pExtData As LongPtr 'const Byte
    cbExtData As Long
End Type

Public Enum SchGetExtensionsOptions
    SCH_EXTENSIONS_OPTIONS_NONE = &H0
    SCH_NO_RECORD_HEADER = &H1 ' Specifies that the ClientHello message does not contain the record header.
End Enum

Public Delegate Function SslGetExtensionsFn (clientHello As Any, ByVal clientHelloByteSize As Long, genericExtensions As SCH_EXTENSION_DATA, ByVal genericExtensionsCount As Byte, bytesToRead As Long, ByVal dwFlags As SchGetExtensionsOptions) As SECURITY_STATUS
Public Declare PtrSafe Function SslGetExtensions Lib "schannel.dll" (clientHello As Any, ByVal clientHelloByteSize As Long, genericExtensions As SCH_EXTENSION_DATA, ByVal genericExtensionsCount As Byte, bytesToRead As Long, ByVal dwFlags As SchGetExtensionsOptions) As SECURITY_STATUS

Public Delegate Function SslDeserializeCertificateStoreFn (SerializedCertificateStore As CERT_BLOB, ppCertContext As LongPtr) As SECURITY_STATUS
Public Declare PtrSafe Function SslDeserializeCertificateStore Lib "schannel.dll" (SerializedCertificateStore As CERT_BLOB, ppCertContext As LongPtr) As SECURITY_STATUS








Public Enum SchannelCrackCertFlags
    CF_VERIFY_SIG = 1
    CF_CERT_FROM_FILE = 2
End Enum








/*
credssp.h
100% coverage
*/

Public Const CREDSSP_NAME  = "CREDSSP"
Public Const TS_SSP_NAME_A  = "TSSSP"
Public Const TS_SSP_NAME  = "TSSSP"
Public Const szOID_TS_KP_TS_SERVER_AUTH  = "1.3.6.1.4.1.311.54.1.2"

Public Type SecPkgContext_ClientCreds
    AuthBufferLen As Long
    AuthBuffer As LongPtr 'PUCHAR
End Type

Public Enum CredSspServerAuthTypes
    CREDSSP_SERVER_AUTH_NEGOTIATE = &H1
    CREDSSP_SERVER_AUTH_CERTIFICATE = &H2
    CREDSSP_SERVER_AUTH_LOOPBACK = &H4
End Enum

Public Enum SecPkgCredAttributes
    SECPKG_ALT_ATTR = &H80000000
    SECPKG_ATTR_CREDS = &H80000080
    SECPKG_ATTR_NEGOTIATION_PACKAGE = &H80000081
    SECPKG_ATTR_C_ACCESS_TOKEN = (SECPKG_ATTR_ACCESS_TOKEN Or SECPKG_ALT_ATTR)
    SECPKG_ATTR_C_FULL_ACCESS_TOKEN = &H80000082
    SECPKG_ATTR_SERVER_AUTH_FLAGS = &H80000083
    SECPKG_ATTR_CERT_TRUST_STATUS = &H80000084
    SECPKG_ATTR_C_FULL_IDENT_TOKEN = &H80000085
    SECPKG_ATTR_CREDS_2 = &H80000086
End Enum

Public Enum CREDSSP_SUBMIT_TYPE
    CredsspPasswordCreds = 2
    CredsspSchannelCreds = 4
    CredsspCertificateCreds = 13
    CredsspSubmitBufferBoth = 50
    CredsspSubmitBufferBothOld = 51
    CredsspCredEx = 100
End Enum

Public Type CREDSSP_CRED
    Type As CREDSSP_SUBMIT_TYPE
    pSchannelCred As LongPtr
    pSpnegoCred As LongPtr
End Type

Public Enum CredSspCredExVerions
    CREDSSP_CRED_EX_VERSION = 0
End Enum
Public Enum CredSspFlags
    CREDSSP_FLAG_REDIRECT = &H1
End Enum
Public Type CREDSSP_CRED_EX
    Type As CREDSSP_SUBMIT_TYPE ' must be CredsspCredEx
    Version As CredSspCredExVerions ' must be CREDSSP_CRED_EX_VERSION
    Flags As CredSspFlags
    Reserved As Long
    Cred As CREDSSP_CRED
End Type



/*
secext.h
Coverage: 100%
*/
Public Enum EXTENDED_NAME_FORMAT
    '  unknown name type
    NameUnknown = 0
    '  CN=John Doe, OU=Software, OU=Engineering, O=Widget, C=US
    NameFullyQualifiedDN = 1
    '  Engineering\JohnDoe
    NameSamCompatible = 2
    '  Probably "John Doe" but could be something else.  I.e. The
    '  display name is not necessarily the defining RDN.
    NameDisplay = 3
    '  String-ized GUID as returned by IIDFromString().
    '  eg: {4fa050f0-f561-11cf-bdd9-00aa003a77b6}
    NameUniqueId = 6
    '  engineering.widget.com/software/John Doe
    NameCanonical = 7
    '  someone@example.com
    NameUserPrincipal = 8
    '  Same as NameCanonical except that rightmost '/' is
    '  replaced with '\n' - even in domain-only case.
    '  eg: engineering.widget.com/software\nJohn Doe
    NameCanonicalEx = 9
    '  www/srv.engineering.com/engineering.com
    NameServicePrincipal = 10
    '  DNS domain name + SAM username
    '  eg: engineering.widget.com\JohnDoe
    NameDnsDomain = 12
    NameGivenName = 13
    NameSurname = 14
End Enum
Public Declare PtrSafe Function GetUserNameExA Lib "secur32" (ByVal NameFormat As EXTENDED_NAME_FORMAT, ByVal lpNameBuffer As String, nSize As Long) As Byte
Public Declare PtrSafe Function GetUserNameExW Lib "secur32" (ByVal NameFormat As EXTENDED_NAME_FORMAT, ByVal lpNameBuffer As LongPtr, nSize As Long) As Byte
Public DeclareWide PtrSafe Function GetUserNameEx Lib "secur32" Alias "GetUserNameExW" (ByVal NameFormat As EXTENDED_NAME_FORMAT, ByVal lpNameBuffer As String, nSize As Long) As Byte
Public Declare PtrSafe Function GetComputerObjectNameA Lib "secur32" (ByVal NameFormat As EXTENDED_NAME_FORMAT, ByVal lpNameBuffer As String, nSize As Long) As Byte
Public Declare PtrSafe Function GetComputerObjectNameW Lib "secur32" (ByVal NameFormat As EXTENDED_NAME_FORMAT, ByVal lpNameBuffer As LongPtr, nSize As Long) As Byte
Public DeclareWide PtrSafe Function GetComputerObjectName Lib "secur32" Alias "GetComputerObjectNameW" (ByVal NameFormat As EXTENDED_NAME_FORMAT, ByVal lpNameBuffer As String, nSize As Long) As Byte
Public Declare PtrSafe Function TranslateNameA Lib "secur32" (ByVal lpAccountName As String, ByVal AccountNameFormat As EXTENDED_NAME_FORMAT, ByVal DesiredNameFormat As EXTENDED_NAME_FORMAT, ByVal lpTranslatedName As String, nSize As Long) As Byte
Public Declare PtrSafe Function TranslateNameW Lib "secur32" (ByVal lpAccountName As LongPtr, ByVal AccountNameFormat As EXTENDED_NAME_FORMAT, ByVal DesiredNameFormat As EXTENDED_NAME_FORMAT, ByVal lpTranslatedName As LongPtr, nSize As Long) As Byte
Public DeclareWide PtrSafe Function TranslateName Lib "secur32" Alias "TranslateNameW" (ByVal lpAccountName As String, ByVal AccountNameFormat As EXTENDED_NAME_FORMAT, ByVal DesiredNameFormat As EXTENDED_NAME_FORMAT, ByVal lpTranslatedName As String, nSize As Long) As Byte



'sspi.h GUIDs

Public Function SEC_WINNT_AUTH_DATA_TYPE_PASSWORD() As UUID
'{28BFC32F-10F6-4738-98D1-1AC061DF716A}
Static iid As UUID
 If (iid.Data1 = 0) Then Call DEFINE_UUID(iid, &H28BFC32F, CInt(&H10F6), CInt(&H4738), &H98, &HD1, &H1A, &HC0, &H61, &HDF, &H71, &H6A)
 SEC_WINNT_AUTH_DATA_TYPE_PASSWORD = iid
End Function
Public Function SEC_WINNT_AUTH_DATA_TYPE_CERT() As UUID
'{235F69AD-73FB-4dbc-8203-0629E739339B}
Static iid As UUID
 If (iid.Data1 = 0) Then Call DEFINE_UUID(iid, &H235F69AD, CInt(&H73FB), CInt(&H4dbc), &H82, &H03, &H06, &H29, &HE7, &H39, &H33, &H9B)
 SEC_WINNT_AUTH_DATA_TYPE_CERT = iid
End Function
Public Function SEC_WINNT_AUTH_DATA_TYPE_CREDMAN_CERT() As UUID
'{7CB72412-1016-491A-8C87-4D2AA1B7DD3A}
Static iid As UUID
 If (iid.Data1 = 0) Then Call DEFINE_UUID(iid, &H7CB72412, CInt(&H1016), CInt(&H491A), &H8C, &H87, &H4D, &H2A, &HA1, &HB7, &HDD, &H3A)
 SEC_WINNT_AUTH_DATA_TYPE_CREDMAN_CERT = iid
End Function
Public Function SEC_WINNT_AUTH_DATA_TYPE_NGC() As UUID
'{10A47879-5EBF-4B85-BD8D-C21BB4F49C8A}
Static iid As UUID
 If (iid.Data1 = 0) Then Call DEFINE_UUID(iid, &H10A47879, CInt(&H5EBF), CInt(&H4B85), &HBD, &H8D, &HC2, &H1B, &HB4, &HF4, &H9C, &H8A)
 SEC_WINNT_AUTH_DATA_TYPE_NGC = iid
End Function
Public Function SEC_WINNT_AUTH_DATA_TYPE_FIDO() As UUID
'{32E8F8D7-7871-4BCC-83C5-460F66C6135C}
Static iid As UUID
 If (iid.Data1 = 0) Then Call DEFINE_UUID(iid, &H32E8F8D7, CInt(&H7871), CInt(&H4BCC), &H83, &HC5, &H46, &H0F, &H66, &HC6, &H13, &H5C)
 SEC_WINNT_AUTH_DATA_TYPE_FIDO = iid
End Function
Public Function SEC_WINNT_AUTH_DATA_TYPE_KEYTAB() As UUID
'{D587AAE8-F78F-4455-A112-C934BEEE7CE1}
Static iid As UUID
 If (iid.Data1 = 0) Then Call DEFINE_UUID(iid, &HD587AAE8, CInt(&HF78F), CInt(&H4455), &HA1, &H12, &HC9, &H34, &HBE, &HEE, &H7C, &HE1)
 SEC_WINNT_AUTH_DATA_TYPE_KEYTAB = iid
End Function
Public Function SEC_WINNT_AUTH_DATA_TYPE_DELEGATION_TOKEN() As UUID
'{12E52E0F-6F9B-4F83-9020-9DE42B226267}
Static iid As UUID
 If (iid.Data1 = 0) Then Call DEFINE_UUID(iid, &H12E52E0F, CInt(&H6F9B), CInt(&H4F83), &H90, &H20, &H9D, &HE4, &H2B, &H22, &H62, &H67)
 SEC_WINNT_AUTH_DATA_TYPE_DELEGATION_TOKEN = iid
End Function
Public Function SEC_WINNT_AUTH_DATA_TYPE_CSP_DATA() As UUID
'{68FD9879-079C-4dfe-8281-578AADC1C100}
Static iid As UUID
 If (iid.Data1 = 0) Then Call DEFINE_UUID(iid, &H68FD9879, CInt(&H079C), CInt(&H4dfe), &H82, &H81, &H57, &H8A, &HAD, &HC1, &HC1, &H00)
 SEC_WINNT_AUTH_DATA_TYPE_CSP_DATA = iid
End Function
Public Function SEC_WINNT_AUTH_DATA_TYPE_SMARTCARD_CONTEXTS() As UUID
'{B86C4FF3-49D7-4DC4-B560-B1163685B236}
Static iid As UUID
 If (iid.Data1 = 0) Then Call DEFINE_UUID(iid, &HB86C4FF3, CInt(&H49D7), CInt(&H4DC4), &HB5, &H60, &HB1, &H16, &H36, &H85, &HB2, &H36)
 SEC_WINNT_AUTH_DATA_TYPE_SMARTCARD_CONTEXTS = iid
End Function
Public Function CREDUIWIN_STRUCTURE_TYPE_SSPIPFC() As UUID
'{3C3E93D9-D96B-49b5-94A7-458592088337}
Static iid As UUID
 If (iid.Data1 = 0) Then Call DEFINE_UUID(iid, &H3C3E93D9, CInt(&HD96B), CInt(&H49b5), &H94, &HA7, &H45, &H85, &H92, &H08, &H83, &H37)
 CREDUIWIN_STRUCTURE_TYPE_SSPIPFC = iid
End Function
Public Function SSPIPFC_STRUCTURE_TYPE_CREDUI_CONTEXT() As UUID
'{C2FFFE6F-503D-4c3d-A95E-BCE821213D44}
Static iid As UUID
 If (iid.Data1 = 0) Then Call DEFINE_UUID(iid, &HC2FFFE6F, CInt(&H503D), CInt(&H4c3d), &HA9, &H5E, &HBC, &HE8, &H21, &H21, &H3D, &H44)
 SSPIPFC_STRUCTURE_TYPE_CREDUI_CONTEXT = iid
End Function








'tokenbinding.h

Public Enum TOKENBINDING_TYPE
    TOKENBINDING_TYPE_PROVIDED = 0
    TOKENBINDING_TYPE_REFERRED = 1
End Enum

Public Enum TOKENBINDING_EXTENSION_FORMAT
    TOKENBINDING_EXTENSION_FORMAT_UNDEFINED = 0
End Enum

Public Enum TOKENBINDING_KEY_PARAMETERS_TYPE
    TOKENBINDING_KEY_PARAMETERS_TYPE_RSA2048_PKCS = 0
    TOKENBINDING_KEY_PARAMETERS_TYPE_RSA2048_PSS = 1
    TOKENBINDING_KEY_PARAMETERS_TYPE_ECDSAP256 = 2
    TOKENBINDING_KEY_PARAMETERS_TYPE_ANYEXISTING = 255
End Enum

[PackingAlignment(1)]
Public Type TOKENBINDING_IDENTIFIER
    keyType As Byte ' TOKENBINDING_KEY_PARAMETERS_TYPE
End Type

Public Type TOKENBINDING_RESULT_DATA
    bindingType As TOKENBINDING_TYPE
    identifierSize As Long
    identifierData As LongPtr 'TOKENBINDING_IDENTIFIER*
    extensionFormat As TOKENBINDING_EXTENSION_FORMAT
    extensionSize As Long
    extensionData As LongPtr
End Type

Public Type TOKENBINDING_RESULT_LIST
    resultCount As Long
    resultData As TOKENBINDING_RESULT_DATA
End Type

Public Type TOKENBINDING_KEY_TYPES
    keyCount As Long
    keyType As TOKENBINDING_KEY_PARAMETERS_TYPE
End Type

Public DeclareWide PtrSafe Function TokenBindingGenerateBinding Lib "tokenbinding.dll" (ByVal keyType As TOKENBINDING_KEY_PARAMETERS_TYPE, ByVal targetUrl As String, ByVal bindingType As TOKENBINDING_TYPE, tlsEKM As Any, ByVal tlsEKMSize As Long, ByVal extensionFormat As TOKENBINDING_EXTENSION_FORMAT, extensionData As Any, tokenBinding As LongPtr, tokenBindingSize As Long, Optional resultData As LongPtr) As SECURITY_STATUS
Public DeclareWide PtrSafe Function TokenBindingGenerateBinding Lib "tokenbinding.dll" (ByVal keyType As TOKENBINDING_KEY_PARAMETERS_TYPE, ByVal targetUrl As LongPtr, ByVal bindingType As TOKENBINDING_TYPE, tlsEKM As Any, ByVal tlsEKMSize As Long, ByVal extensionFormat As TOKENBINDING_EXTENSION_FORMAT, extensionData As Any, tokenBinding As LongPtr, tokenBindingSize As Long, Optional resultData As LongPtr) As SECURITY_STATUS
Public DeclareWide PtrSafe Function TokenBindingGenerateMessage Lib "tokenbinding.dll" (tokenBindings As Any, tokenBindingSize As Long, ByVal tokenBindingsCount As Long, tokenBindingMessage As LongPtr, tokenBindingMessageSize As Long) As SECURITY_STATUS
Public DeclareWide PtrSafe Function TokenBindingVerifyMessage Lib "tokenbinding.dll" (tokenBindingMessage As Any, ByVal tokenBindingMessageSize As Long, ByVal keyType As TOKENBINDING_KEY_PARAMETERS_TYPE, tlsEKM As Any, ByVal tlsEKMSize As Long, resultList As LongPtr) As SECURITY_STATUS
Public Declare PtrSafe Function TokenBindingGetKeyTypesClient Lib "tokenbinding.dll" (keyTypes As LongPtr) As SECURITY_STATUS
Public Declare PtrSafe Function TokenBindingGetKeyTypesServer Lib "tokenbinding.dll" (keyTypes As LongPtr) As SECURITY_STATUS
Public DeclareWide PtrSafe Function TokenBindingDeleteBinding Lib "tokenbinding.dll" (ByVal targetURL As String) As SECURITY_STATUS
Public Declare PtrSafe Function TokenBindingDeleteBinding Lib "tokenbinding.dll" (ByVal targetURL As LongPtr) As SECURITY_STATUS
Public Declare PtrSafe Function TokenBindingDeleteAllBindings Lib "tokenbinding.dll" () As SECURITY_STATUS
Public DeclareWide PtrSafe Function TokenBindingGenerateID Lib "tokenbinding.dll" (ByVal keyType As TOKENBINDING_KEY_PARAMETERS_TYPE, publicKey As Any, ByVal publicKeySize As Long, resultData As LongPtr) As SECURITY_STATUS
Public DeclareWide PtrSafe Function TokenBindingGenerateIDForUri Lib "tokenbinding.dll" (ByVal keyType As TOKENBINDING_KEY_PARAMETERS_TYPE, ByVal targetUri As String, resultData As LongPtr) As SECURITY_STATUS
Public Declare PtrSafe Function TokenBindingGenerateIDForUri Lib "tokenbinding.dll" (ByVal keyType As TOKENBINDING_KEY_PARAMETERS_TYPE, ByVal targetUri As LongPtr, resultData As LongPtr) As SECURITY_STATUS
Public Declare PtrSafe Function TokenBindingGetHighestSupportedVersion Lib "tokenbinding.dll" (majorVersion As Byte, minorVersion As Byte) As SECURITY_STATUS



'keycredmgr.h

Public Enum KeyCredentialManagerOperationErrorStates
    KeyCredentialManagerOperationErrorStateNone = &H0
    KeyCredentialManagerOperationErrorStateDeviceJoinFailure = &H01
    KeyCredentialManagerOperationErrorStateTokenFailure = &H02
    KeyCredentialManagerOperationErrorStateCertificateFailure = &H04
    KeyCredentialManagerOperationErrorStateRemoteSessionFailure = &H08
    KeyCredentialManagerOperationErrorStatePolicyFailure = &H10
    KeyCredentialManagerOperationErrorStateHardwareFailure = &H20
    KeyCredentialManagerOperationErrorStatePinExistsFailure = &H40
End Enum

Public Enum KeyCredentialManagerOperationType
    KeyCredentialManagerProvisioning = 0
    KeyCredentialManagerPinChange = 1
    KeyCredentialManagerPinReset = 2
End Enum

Public Type KeyCredentialManagerInfo
    containerId As UUID
End Type

[UseGetLastError(False)]
Public Declare PtrSafe Function KeyCredentialManagerGetOperationErrorStates Lib "KeyCredMgr.dll" (ByVal keyCredentialManagerOperationType As KeyCredentialManagerOperationType, isReady As BOOL, keyCredentialManagerOperationErrorStates As KeyCredentialManagerOperationErrorStates) As Long
[UseGetLastError(False)]
Public Declare PtrSafe Function KeyCredentialManagerShowUIOperation Lib "KeyCredMgr.dll" (ByVal hWndOwner As LongPtr, ByVal keyCredentialManagerOperationType As KeyCredentialManagerOperationType) As Long
[UseGetLastError(False)]
Public Declare PtrSafe Function KeyCredentialManagerGetInformation Lib "KeyCredMgr.dll" (keyCredentialManagerInfo As LongPtr) As Long
[UseGetLastError(False)]
Public Declare PtrSafe Sub KeyCredentialManagerFreeInformation Lib "KeyCredMgr.dll" (ByVal keyCredentialManagerInfo As LongPtr)


'SubAuth.h


Public Type OLD_LARGE_INTEGER
    LowPart As Long
    HighPart As Long
End Type

Public Const SAM_DAYS_PER_WEEK  = (7)
Public Const SAM_HOURS_PER_WEEK  = (24 * SAM_DAYS_PER_WEEK)
Public Const SAM_MINUTES_PER_WEEK  = (60 * SAM_HOURS_PER_WEEK)

Public Type LOGON_HOURS
    UnitsPerWeek As Integer
    ' UnitsPerWeek is the number of equal length time units the week is
    ' divided into.  This value is used to compute the length of the bit
    ' string in logon_hours.  Must be less than or equal to
    ' SAM_UNITS_PER_WEEK (10080) for this release.
    ' LogonHours is a bit map of valid logon times.  Each bit represents
    ' a unique division in a week.  The largest bit map supported is 1260
    ' bytes (10080 bits), which represents minutes per week.  In this case
    ' the first bit (bit 0, byte 0) is Sunday, 00:00:00 - 00-00:59; bit 1,
    ' byte 0 is Sunday, 00:01:00 - 00:01:59, etc.  A NULL pointer means
    ' DONT_CHANGE for SamSetInformationUser() calls.
    LogonHours As LongPtr
End Type

Public Type SR_SECURITY_DESCRIPTOR
    Length As Long
    SecurityDescriptor As LongPtr
End Type

[PackingAlignment(4)]
Public Type USER_ALL_INFORMATION
    LastLogon As LARGE_INTEGER
    LastLogoff As LARGE_INTEGER
    PasswordLastSet As LARGE_INTEGER
    AccountExpires As LARGE_INTEGER
    PasswordCanChange As LARGE_INTEGER
    PasswordMustChange As LARGE_INTEGER
    UserName As UNICODE_STRING
    FullName As UNICODE_STRING
    HomeDirectory As UNICODE_STRING
    HomeDirectoryDrive As UNICODE_STRING
    ScriptPath As UNICODE_STRING
    ProfilePath As UNICODE_STRING
    AdminComment As UNICODE_STRING
    WorkStations As UNICODE_STRING
    UserComment As UNICODE_STRING
    Parameters As UNICODE_STRING
    LmPassword As UNICODE_STRING
    NtPassword As UNICODE_STRING
    PrivateData As UNICODE_STRING
    SecurityDescriptor As SR_SECURITY_DESCRIPTOR
    UserId As Long
    PrimaryGroupId As Long
    UserAccountControl As Long
    WhichFields As Long
    LogonHours As LOGON_HOURS
    BadPasswordCount As Integer
    LogonCount As Integer
    CountryCode As Integer
    CodePage As Integer
    LmPasswordPresent As Byte
    NtPasswordPresent As Byte
    PasswordExpired As Byte
    PrivateDataSensitive As Byte
End Type

Public Const USER_ALL_PARAMETERS  = &H00200000
 
Public Const CLEAR_BLOCK_LENGTH  = 8

Public Type CLEAR_BLOCK
    data(0 To (CLEAR_BLOCK_LENGTH - 1)) As Byte
End Type
' Alias CLEAR_BLOCK                 LM_CHALLENGE;
Public Type LM_CHALLENGE
    data(0 To (CLEAR_BLOCK_LENGTH - 1)) As Byte
End Type


Public Const CYPHER_BLOCK_LENGTH = 8

Public Type CYPHER_BLOCK
    data(0 To (CYPHER_BLOCK_LENGTH - 1)) As Byte
End Type

Public Type LM_OWF_PASSWORD
    data(0 To 1) As CYPHER_BLOCK
End Type
'Alias NT_OWF_PASSWORD As LM_OWF_PASSWORD
Public Type NT_OWF_PASSWORD
    data(0 To 1) As CYPHER_BLOCK
End Type




Public Const USER_SESSION_KEY_LENGTH = (CYPHER_BLOCK_LENGTH * 2)

Public Type USER_SESSION_KEY
    data(0 To 1) As CYPHER_BLOCK
End Type

Public Enum NETLOGON_LOGON_INFO_CLASS
    NetlogonInteractiveInformation = 1
    NetlogonNetworkInformation
    NetlogonServiceInformation
    NetlogonGenericInformation
    NetlogonInteractiveTransitiveInformation
    NetlogonNetworkTransitiveInformation
    NetlogonServiceTransitiveInformation
    NetlogonTicketLogonInformation
End Enum

Public Type NETLOGON_LOGON_IDENTITY_INFO
    LogonDomainName As UNICODE_STRING
    ParameterControl As Long
    LogonId As OLD_LARGE_INTEGER
    UserName As UNICODE_STRING
    Workstation As UNICODE_STRING
End Type

Public Type NETLOGON_INTERACTIVE_INFO
    Identity As NETLOGON_LOGON_IDENTITY_INFO
    LmOwfPassword As LM_OWF_PASSWORD
    NtOwfPassword As NT_OWF_PASSWORD
End Type

Public Type NETLOGON_SERVICE_INFO
    Identity As NETLOGON_LOGON_IDENTITY_INFO
    LmOwfPassword As LM_OWF_PASSWORD
    NtOwfPassword As NT_OWF_PASSWORD
End Type

Public Type NETLOGON_NETWORK_INFO
    Identity As NETLOGON_LOGON_IDENTITY_INFO
    LmChallenge As LM_CHALLENGE
    NtChallengeResponse As NT_STRING
    LmChallengeResponse As NT_STRING
End Type

Public Type NETLOGON_GENERIC_INFO
    Identity As NETLOGON_LOGON_IDENTITY_INFO
    PackageName As UNICODE_STRING
    DataLength As Long
    LogonData As LongPtr
End Type

Public Enum NetLogonTargetInfoTypes
    NETLOGON_TARGET_INFO_TYPE_NTLM = 1
    NETLOGON_TARGET_INFO_TYPE_KERBEROS = 2
End Enum
Public Type NETLOGON_TARGET_INFO
    Type As NetLogonTargetInfoTypes
    NbComputerName As UNICODE_STRING
    NbDomainName As UNICODE_STRING
    DnsComputerName As UNICODE_STRING
    DnsDomainName As UNICODE_STRING
    DnsTreeName As UNICODE_STRING
    TargetName As UNICODE_STRING
End Type

Public Enum MSV1_0_SubAuthRoutineFlags
    MSV1_0_PASSTHRU = &H01
    MSV1_0_GUEST_LOGON = &H02
    MSV1_0_KERBEROS_LOGON = &H04
End Enum

Public Delegate Function Msv1_0SubAuthenticationRoutine (ByVal LogonLevel As NETLOGON_LOGON_INFO_CLASS, _
                                                        ByVal LogonInformation As LongPtr, _
                                                        ByVal Flags As MSV1_0_SubAuthRoutineFlags, _
                                                        UserAll As USER_ALL_INFORMATION, _
                                                        WhichFields As MSV1_0_ValidationFields, _
                                                        UserFlags As Long, _
                                                        Authoritative As Byte, _
                                                        LogoffTime As LARGE_INTEGER, _
                                                        KickoffTime As LARGE_INTEGER) As NTSTATUS


Public Type MSV1_0_VALIDATION_INFO
    LogoffTime As LARGE_INTEGER
    KickoffTime As LARGE_INTEGER
    LogonServer As UNICODE_STRING
    LogonDomainName As UNICODE_STRING
    SessionKey As USER_SESSION_KEY
    Authoritative As Byte
    UserFlags As Long
    WhichFields As MSV1_0_ValidationFields
    UserId As Long
End Type

Public Enum MSV1_0_ValidationFields
    MSV1_0_VALIDATION_LOGOFF_TIME = &H00000001
    MSV1_0_VALIDATION_KICKOFF_TIME = &H00000002
    MSV1_0_VALIDATION_LOGON_SERVER = &H00000004
    MSV1_0_VALIDATION_LOGON_DOMAIN = &H00000008
    MSV1_0_VALIDATION_SESSION_KEY = &H00000010
    MSV1_0_VALIDATION_USER_FLAGS = &H00000020
    MSV1_0_VALIDATION_USER_ID = &H00000040
End Enum

Public Enum MSV1_0_ValidationActions
    MSV1_0_SUBAUTH_ACCOUNT_DISABLED = &H00000001
    MSV1_0_SUBAUTH_PASSWORD = &H00000002
    MSV1_0_SUBAUTH_WORKSTATIONS = &H00000004
    MSV1_0_SUBAUTH_LOGON_HOURS = &H00000008
    MSV1_0_SUBAUTH_ACCOUNT_EXPIRY = &H00000010
    MSV1_0_SUBAUTH_PASSWORD_EXPIRY = &H00000020
    MSV1_0_SUBAUTH_ACCOUNT_TYPE = &H00000040
    MSV1_0_SUBAUTH_LOCKOUT = &H00000080
End Enum

Public Delegate Function Msv1_0SubAuthenticationRoutineEx (ByVal LogonLevel As NETLOGON_LOGON_INFO_CLASS, ByVal LogonInformation As LongPtr, ByVal Flags As Long, UserAll As USER_ALL_INFORMATION, ByVal UserHandle As LongPtr, ValidationInfo As MSV1_0_VALIDATION_INFO, ActionsPerformed As MSV1_0_ValidationActions) As NTSTATUS

Public Delegate Function Msv1_0SubAuthenticationRoutineGeneric (ByVal SubmitBuffer As LongPtr, ByVal SubmitBufferLength As Long, ReturnBufferLength As Long, ByRef ReturnBuffer As LongPtr) As NTSTATUS

Public Delegate Function Msv1_0SubAuthenticationFilter (ByVal LogonLevel As NETLOGON_LOGON_INFO_CLASS, ByVal LogonInformation As LongPtr, ByVal Flags As Long, UserAll As USER_ALL_INFORMATION, WhichFields As MSV1_0_ValidationFields, UserFlags As Long, Authoritative As Byte, LogoffTime As LARGE_INTEGER, KickoffTime As LARGE_INTEGER) As NTSTATUS





End Module
#End If